<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>exiled Â· chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: #1a1a1a;
      color: white;
      height: 100vh;
      overflow: hidden;
    }

    /* Auth Pages */
    .auth-container {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: url('https://i.pinimg.com/originals/f2/f3/93/f2f393327208542afade5799bcd3814a.gif') center/cover;
      position: relative;
    }

    .auth-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
    }

    .auth-card {
      position: relative;
      z-index: 10;
      background: rgba(30,30,30,0.9);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      width: 400px;
      border: 1px solid rgba(255,255,255,0.1);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .auth-card h1 {
      font-size: 3rem;
      text-align: center;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #fff, #aaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .auth-input {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      background: rgba(0,0,0,0.3);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      outline: none;
      transition: 0.3s;
    }

    .auth-input:focus {
      border-color: #5865f2;
      background: rgba(0,0,0,0.5);
    }

    .auth-btn {
      width: 100%;
      padding: 15px;
      margin: 20px 0;
      background: #5865f2;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    .auth-btn:hover {
      background: #4752c4;
      transform: translateY(-2px);
    }

    .auth-link {
      color: #aaa;
      text-align: center;
      display: block;
      cursor: pointer;
      transition: 0.3s;
    }

    .auth-link:hover {
      color: white;
    }

    .message {
      color: #ffd966;
      text-align: center;
      margin: 10px 0;
      font-size: 0.9rem;
    }

    /* Main App */
    .app-container {
      display: none;
      height: 100vh;
      background: #1a1a1a;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: #1e1e1e;
      border-right: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .server-list {
      width: 72px;
      background: #1a1a1a;
      border-right: 1px solid rgba(255,255,255,0.1);
      padding: 12px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .server-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: 0.3s;
      position: relative;
    }

    .server-icon:hover {
      border-radius: 16px;
      background: #5865f2;
    }

    .server-icon.active {
      border-radius: 16px;
      background: #5865f2;
    }

    .server-icon.active::before {
      content: '';
      position: absolute;
      left: -12px;
      width: 4px;
      height: 20px;
      background: white;
      border-radius: 4px;
    }

    /* Channel List */
    .channel-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .channel-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .channel-header i {
      color: #aaa;
      cursor: pointer;
      transition: 0.3s;
    }

    .channel-header i:hover {
      color: white;
    }

    .channel-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .channel-category {
      color: #aaa;
      font-size: 0.8rem;
      text-transform: uppercase;
      padding: 10px 10px 5px;
      letter-spacing: 0.5px;
    }

    .channel-item {
      padding: 8px 12px;
      margin: 2px 0;
      border-radius: 8px;
      color: #aaa;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: 0.3s;
    }

    .channel-item:hover {
      background: #2a2a2a;
      color: white;
    }

    .channel-item.active {
      background: #2a2a2a;
      color: white;
    }

    .channel-item i {
      font-size: 1rem;
      width: 20px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #2a2a2a;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-header-left i {
      color: #aaa;
    }

    .chat-header-right {
      display: flex;
      gap: 15px;
      color: #aaa;
    }

    .chat-header-right i {
      cursor: pointer;
      transition: 0.3s;
    }

    .chat-header-right i:hover {
      color: white;
    }

    /* Messages */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message-wrapper {
      display: flex;
      gap: 15px;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
    }

    .message-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .message-content {
      flex: 1;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }

    .message-author {
      font-weight: 600;
      cursor: pointer;
    }

    .message-author:hover {
      color: #5865f2;
    }

    .message-time {
      font-size: 0.8rem;
      color: #aaa;
    }

    .message-text {
      color: #ddd;
      line-height: 1.4;
    }

    .message-text img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 10px;
      margin-top: 5px;
    }

    /* Message Input */
    .message-input-container {
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .message-input-wrapper {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .message-input-wrapper i {
      color: #aaa;
      cursor: pointer;
      transition: 0.3s;
    }

    .message-input-wrapper i:hover {
      color: white;
    }

    .message-input {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-size: 1rem;
      outline: none;
    }

    .message-input::placeholder {
      color: #aaa;
    }

    /* User Panel */
    .user-panel {
      padding: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: 0.3s;
    }

    .user-panel:hover {
      background: #2a2a2a;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .user-status {
      font-size: 0.8rem;
      color: #aaa;
    }

    .user-status i {
      font-size: 0.6rem;
      color: #3ba55d;
      margin-right: 4px;
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #2a2a2a;
      border-radius: 20px;
      padding: 30px;
      width: 500px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: modalPop 0.3s;
    }

    @keyframes modalPop {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: white;
    }

    .modal-header i {
      color: #aaa;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1.5rem;
    }

    .modal-header i:hover {
      color: white;
    }

    .profile-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .profile-banner {
      width: 100%;
      height: 150px;
      background: #1e1e1e;
      border-radius: 10px;
      margin-bottom: -50px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .profile-banner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .banner-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: 0.3s;
    }

    .profile-banner:hover .banner-overlay {
      opacity: 1;
    }

    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid #2a2a2a;
      margin: 0 auto;
      position: relative;
      cursor: pointer;
      overflow: hidden;
    }

    .profile-avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: 0.3s;
    }

    .profile-avatar-large:hover .avatar-overlay {
      opacity: 1;
    }

    .profile-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: #1e1e1e;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: white;
      outline: none;
    }

    .profile-input:focus {
      border-color: #5865f2;
    }

    .friends-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .friend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #1e1e1e;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    .friend-item:hover {
      background: #3a3a3a;
    }

    .friend-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .friend-info {
      flex: 1;
    }

    .friend-name {
      font-weight: 600;
    }

    .friend-status {
      font-size: 0.8rem;
      color: #3ba55d;
    }

    .add-friend-btn {
      background: #5865f2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    .add-friend-btn:hover {
      background: #4752c4;
    }

    .loading-spinner {
      text-align: center;
      padding: 50px;
    }

    .loading-spinner i {
      font-size: 3rem;
      color: #5865f2;
      margin-bottom: 20px;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #5865f2;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      animation: slideIn 0.3s;
      z-index: 2000;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <!-- Auth Container -->
  <div class="auth-container" id="authContainer">
    <div class="auth-overlay"></div>
    
    <!-- Login Card -->
    <div class="auth-card" id="loginCard">
      <h1>EXILED</h1>
      <input type="email" class="auth-input" id="loginEmail" placeholder="Email">
      <input type="password" class="auth-input" id="loginPassword" placeholder="Password">
      <button class="auth-btn" id="loginBtn">Log In</button>
      <div class="message" id="loginMessage"></div>
      <span class="auth-link" id="showSignup">Don't have an account? Sign Up</span>
    </div>

    <!-- Signup Card -->
    <div class="auth-card" id="signupCard" style="display: none;">
      <h1>EXILED</h1>
      <input type="text" class="auth-input" id="signupUsername" placeholder="Username">
      <input type="email" class="auth-input" id="signupEmail" placeholder="Email">
      <input type="password" class="auth-input" id="signupPassword" placeholder="Password">
      <button class="auth-btn" id="signupBtn">Sign Up</button>
      <div class="message" id="signupMessage"></div>
      <span class="auth-link" id="showLogin">Already have an account? Log In</span>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container" id="appContainer">
    <!-- Left Sidebar -->
    <div style="display: flex; height: 100%;">
      <!-- Server List -->
      <div class="server-list">
        <div class="server-icon active">E</div>
        <div class="server-icon">+</div>
      </div>

      <!-- Channel Sidebar -->
      <div class="sidebar">
        <div class="channel-container">
          <div class="channel-header">
            <i class="fas fa-bars"></i>
            <span>Exiled</span>
            <i class="fas fa-plus-circle" style="margin-left: auto;" onclick="showModal('friendsModal')"></i>
          </div>

          <div class="channel-list">
            <div class="channel-category">Text Channels</div>
            <div class="channel-item active" onclick="switchChannel('general')">
              <i class="fas fa-hashtag"></i> general
            </div>
            <div class="channel-item" onclick="switchChannel('off-topic')">
              <i class="fas fa-hashtag"></i> off-topic
            </div>
            <div class="channel-item" onclick="switchChannel('music')">
              <i class="fas fa-music"></i> music
            </div>

            <div class="channel-category" style="margin-top: 20px;">Voice Channels</div>
            <div class="channel-item">
              <i class="fas fa-volume-up"></i> General Voice
            </div>
            <div class="channel-item">
              <i class="fas fa-volume-up"></i> Music Lounge
            </div>

            <div class="channel-category" style="margin-top: 20px;">Friends</div>
            <div class="channel-item" onclick="showModal('friendsModal')">
              <i class="fas fa-user-friends"></i> Online Friends
            </div>
          </div>
        </div>

        <!-- User Panel -->
        <div class="user-panel" onclick="showModal('profileModal')">
          <div class="user-avatar" id="currentUserAvatar">
            <span id="avatarInitial">U</span>
          </div>
          <div class="user-info">
            <div class="user-name" id="currentUsername">Loading...</div>
            <div class="user-status">
              <i class="fas fa-circle"></i> Online
            </div>
          </div>
          <i class="fas fa-microphone" style="color: #aaa;"></i>
          <i class="fas fa-headphones" style="color: #aaa;"></i>
          <i class="fas fa-cog" style="color: #aaa;" onclick="event.stopPropagation(); showModal('settingsModal')"></i>
        </div>
      </div>

      <!-- Main Chat Area -->
      <div class="main-content">
        <div class="chat-header">
          <div class="chat-header-left">
            <i class="fas fa-hashtag"></i>
            <span id="currentChannel">general</span>
          </div>
          <div class="chat-header-right">
            <i class="fas fa-phone-alt"></i>
            <i class="fas fa-video"></i>
            <i class="fas fa-user-plus" onclick="showModal('friendsModal')"></i>
            <i class="fas fa-search"></i>
            <i class="fas fa-inbox"></i>
            <i class="fas fa-question-circle"></i>
          </div>
        </div>

        <!-- Messages -->
        <div class="messages-container" id="messagesContainer">
          <!-- Messages will be inserted here -->
        </div>

        <!-- Message Input -->
        <div class="message-input-container">
          <div class="message-input-wrapper">
            <i class="fas fa-plus-circle"></i>
            <input type="text" class="message-input" id="messageInput" placeholder="Message #general">
            <i class="fas fa-gift"></i>
            <i class="fas fa-gif"></i>
            <i class="fas fa-smile"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal" id="profileModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Your Profile</h2>
        <i class="fas fa-times" onclick="hideModal('profileModal')"></i>
      </div>

      <div class="profile-section">
        <!-- Banner -->
        <div class="profile-banner" id="bannerUpload">
          <img id="profileBanner" src="https://via.placeholder.com/500x150/1e1e1e/666666?text=Click+to+upload+banner" alt="banner">
          <div class="banner-overlay">
            <i class="fas fa-camera"></i>
          </div>
          <input type="file" id="bannerInput" style="display: none;" accept="image/*">
        </div>

        <!-- Avatar -->
        <div class="profile-avatar-large" id="avatarUpload">
          <img id="profileAvatar" src="https://via.placeholder.com/100/5865f2/ffffff?text=User" alt="avatar">
          <div class="avatar-overlay">
            <i class="fas fa-camera"></i>
          </div>
          <input type="file" id="avatarInput" style="display: none;" accept="image/*">
        </div>
      </div>

      <input type="text" class="profile-input" id="editUsername" placeholder="Username">
      <textarea class="profile-input" id="editBio" placeholder="About me" rows="3"></textarea>
      <input type="text" class="profile-input" id="editStatus" placeholder="Custom status">

      <button class="auth-btn" id="saveProfileBtn">Save Changes</button>
    </div>
  </div>

  <!-- Friends Modal -->
  <div class="modal" id="friendsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Friends</h2>
        <i class="fas fa-times" onclick="hideModal('friendsModal')"></i>
      </div>

      <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <input type="text" class="profile-input" id="friendUsername" placeholder="Enter username to add" style="flex: 1;">
        <button class="add-friend-btn" onclick="addFriend()">Add Friend</button>
      </div>

      <div class="friends-list" id="friendsList">
        <!-- Friends will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <i class="fas fa-times" onclick="hideModal('settingsModal')"></i>
      </div>

      <div style="padding: 10px 0;">
        <div style="margin: 15px 0;">
          <label style="color: #aaa;">Theme</label>
          <select class="profile-input">
            <option>Dark</option>
            <option>Light</option>
            <option>Sync with system</option>
          </select>
        </div>

        <div style="margin: 15px 0;">
          <label style="color: #aaa;">Notifications</label>
          <select class="profile-input">
            <option>All messages</option>
            <option>Mentions only</option>
            <option>Nothing</option>
          </select>
        </div>

        <button class="auth-btn" id="logoutBtn">Log Out</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // Supabase setup
      const SUPABASE_URL = "https://opixidygpndbfuisjkrk.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_N6RdTgjgUHQbdtvPX9uPqA_VTraUegI";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: true, autoRefreshToken: true }
      });

      // DOM Elements
      const authContainer = document.getElementById('authContainer');
      const appContainer = document.getElementById('appContainer');
      const loginCard = document.getElementById('loginCard');
      const signupCard = document.getElementById('signupCard');
      const loginEmail = document.getElementById('loginEmail');
      const loginPassword = document.getElementById('loginPassword');
      const loginBtn = document.getElementById('loginBtn');
      const loginMessage = document.getElementById('loginMessage');
      const signupUsername = document.getElementById('signupUsername');
      const signupEmail = document.getElementById('signupEmail');
      const signupPassword = document.getElementById('signupPassword');
      const signupBtn = document.getElementById('signupBtn');
      const signupMessage = document.getElementById('signupMessage');
      const showSignup = document.getElementById('showSignup');
      const showLogin = document.getElementById('showLogin');
      const logoutBtn = document.getElementById('logoutBtn');
      
      // Profile elements
      const currentUsername = document.getElementById('currentUsername');
      const currentUserAvatar = document.getElementById('currentUserAvatar');
      const avatarInitial = document.getElementById('avatarInitial');
      const profileAvatar = document.getElementById('profileAvatar');
      const profileBanner = document.getElementById('profileBanner');
      const editUsername = document.getElementById('editUsername');
      const editBio = document.getElementById('editBio');
      const editStatus = document.getElementById('editStatus');
      const saveProfileBtn = document.getElementById('saveProfileBtn');
      
      // Message elements
      const messagesContainer = document.getElementById('messagesContainer');
      const messageInput = document.getElementById('messageInput');
      const currentChannel = document.getElementById('currentChannel');
      
      // Friends
      const friendsList = document.getElementById('friendsList');
      const friendUsername = document.getElementById('friendUsername');

      // State
      let currentUser = null;
      let currentProfile = null;
      let activeChannel = 'general';
      let messages = [];
      let friends = [];
      let messageSubscription = null;

      // Show notification
      function showNotification(text, isError = false) {
        const notif = document.createElement('div');
        notif.className = 'notification';
        notif.textContent = text;
        notif.style.background = isError ? '#ed4245' : '#5865f2';
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
      }

      // Modal functions
      window.showModal = (modalId) => {
        document.getElementById(modalId).classList.add('active');
      };

      window.hideModal = (modalId) => {
        document.getElementById(modalId).classList.remove('active');
      };

      // Switch channel
      window.switchChannel = async (channel) => {
        activeChannel = channel;
        currentChannel.textContent = channel;
        document.querySelectorAll('.channel-item').forEach(c => c.classList.remove('active'));
        event.target.closest('.channel-item').classList.add('active');
        await loadMessages();
      };

      // Load messages
      async function loadMessages() {
        const { data, error } = await supabase
          .from('messages')
          .select(`
            *,
            profiles:user_id (username, avatar_url)
          `)
          .eq('channel', activeChannel)
          .order('created_at', { ascending: true });

        if (data) {
          messages = data;
          renderMessages();
        }
      }

      // Render messages
      function renderMessages() {
        messagesContainer.innerHTML = '';
        messages.forEach(msg => {
          const msgEl = document.createElement('div');
          msgEl.className = 'message-wrapper';
          msgEl.innerHTML = `
            <div class="message-avatar">
              <img src="${msg.profiles?.avatar_url || 'https://via.placeholder.com/40/5865f2/ffffff?text=' + (msg.profiles?.username?.[0] || 'U')}" alt="avatar">
            </div>
            <div class="message-content">
              <div class="message-header">
                <span class="message-author">${msg.profiles?.username || 'Unknown'}</span>
                <span class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</span>
              </div>
              <div class="message-text">${msg.content}</div>
            </div>
          `;
          messagesContainer.appendChild(msgEl);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Send message
      messageInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && messageInput.value.trim()) {
          const content = messageInput.value.trim();
          messageInput.value = '';

          const { error } = await supabase
            .from('messages')
            .insert({
              content,
              channel: activeChannel,
              user_id: currentUser.id
            });

          if (error) {
            showNotification('Failed to send message', true);
          }
        }
      });

      // Subscribe to messages
      function subscribeToMessages() {
        if (messageSubscription) {
          messageSubscription.unsubscribe();
        }

        messageSubscription = supabase
          .channel('messages')
          .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'messages',
            filter: `channel=eq.${activeChannel}`
          }, async (payload) => {
            // Fetch the full message with profile
            const { data } = await supabase
              .from('messages')
              .select(`
                *,
                profiles:user_id (username, avatar_url)
              `)
              .eq('id', payload.new.id)
              .single();

            if (data) {
              messages.push(data);
              renderMessages();
            }
          })
          .subscribe();
      }

      // Load friends
      async function loadFriends() {
        const { data, error } = await supabase
          .from('friends')
          .select(`
            friend_id,
            profiles:friend_id (username, avatar_url, status)
          `)
          .eq('user_id', currentUser.id)
          .eq('status', 'accepted');

        if (data) {
          friends = data.map(f => f.profiles);
          renderFriends();
        }
      }

      // Render friends
      function renderFriends() {
        if (!friendsList) return;
        
        if (friends.length === 0) {
          friendsList.innerHTML = '<div style="text-align: center; color: #aaa; padding: 20px;">No friends yet. Add some!</div>';
          return;
        }

        friendsList.innerHTML = friends.map(friend => `
          <div class="friend-item" onclick="startDM('${friend.username}')">
            <div class="friend-avatar">
              <img src="${friend.avatar_url || 'https://via.placeholder.com/40/5865f2/ffffff?text=' + (friend.username?.[0] || 'U')}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            </div>
            <div class="friend-info">
              <div class="friend-name">${friend.username}</div>
              <div class="friend-status">
                <i class="fas fa-circle"></i> Online
              </div>
            </div>
          </div>
        `).join('');
      }

      // Add friend
      window.addFriend = async () => {
        const username = friendUsername.value.trim();
        if (!username) return;

        // Find user by username
        const { data: user } = await supabase
          .from('profiles')
          .select('id')
          .eq('username', username)
          .single();

        if (!user) {
          showNotification('User not found', true);
          return;
        }

        // Send friend request
        const { error } = await supabase
          .from('friends')
          .insert({
            user_id: currentUser.id,
            friend_id: user.id,
            status: 'pending'
          });

        if (error) {
          showNotification('Failed to add friend', true);
        } else {
          showNotification('Friend request sent!');
          friendUsername.value = '';
        }
      };

      // Avatar upload
      document.getElementById('avatarUpload').addEventListener('click', () => {
        document.getElementById('avatarInput').click();
      });

      document.getElementById('avatarInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result;
          profileAvatar.src = base64;
          
          await supabase
            .from('profiles')
            .update({ avatar_url: base64 })
            .eq('id', currentUser.id);
          
          showNotification('Avatar updated!');
        };
        reader.readAsDataURL(file);
      });

      // Banner upload
      document.getElementById('bannerUpload').addEventListener('click', () => {
        document.getElementById('bannerInput').click();
      });

      document.getElementById('bannerInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result;
          profileBanner.src = base64;
          
          await supabase
            .from('profiles')
            .update({ banner_url: base64 })
            .eq('id', currentUser.id);
          
          showNotification('Banner updated!');
        };
        reader.readAsDataURL(file);
      });

      // Save profile
      saveProfileBtn.addEventListener('click', async () => {
        const updates = {};
        if (editUsername.value) updates.username = editUsername.value;
        if (editBio.value) updates.bio = editBio.value;
        if (editStatus.value) updates.status = editStatus.value;

        await supabase
          .from('profiles')
          .update(updates)
          .eq('id', currentUser.id);

        currentUsername.textContent = editUsername.value;
        avatarInitial.textContent = editUsername.value[0].toUpperCase();
        showNotification('Profile updated!');
        hideModal('profileModal');
      });

      // Login
      loginBtn.addEventListener('click', async () => {
        const email = loginEmail.value.trim();
        const password = loginPassword.value.trim();

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
          loginMessage.textContent = error.message;
          return;
        }

        currentUser = data.user;
        await loadUserData();
      });

      // Signup
      signupBtn.addEventListener('click', async () => {
        const username = signupUsername.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        const email = signupEmail.value.trim();
        const password = signupPassword.value.trim();

        if (username.length < 3) {
          signupMessage.textContent = 'Username must be at least 3 characters';
          return;
        }

        const { data, error } = await supabase.auth.signUp({ email, password });
        
        if (error) {
          signupMessage.textContent = error.message;
          return;
        }

        if (data.user) {
          await supabase
            .from('profiles')
            .insert({ 
              id: data.user.id, 
              username, 
              bio: '', 
              status: 'online',
              avatar_url: null,
              banner_url: null
            });

          // Auto login
          const { data: loginData } = await supabase.auth.signInWithPassword({ email, password });
          currentUser = loginData.user;
          await loadUserData();
        }
      });

      // Load user data
      async function loadUserData() {
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        currentProfile = profile;
        currentUsername.textContent = profile.username;
        avatarInitial.textContent = profile.username[0].toUpperCase();
        
        if (profile.avatar_url) {
          profileAvatar.src = profile.avatar_url;
          document.querySelectorAll('.user-avatar img, .message-avatar img').forEach(img => {
            if (img.closest('.user-avatar') || img.closest('.message-avatar[data-user="' + currentUser.id + '"]')) {
              img.src = profile.avatar_url;
            }
          });
        }

        if (profile.banner_url) {
          profileBanner.src = profile.banner_url;
        }

        editUsername.value = profile.username;
        editBio.value = profile.bio || '';
        editStatus.value = profile.status || '';

        authContainer.style.display = 'none';
        appContainer.style.display = 'block';

        await loadMessages();
        await loadFriends();
        subscribeToMessages();
      }

      // Logout
      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        currentUser = null;
        currentProfile = null;
        appContainer.style.display = 'none';
        authContainer.style.display = 'flex';
        if (messageSubscription) {
          messageSubscription.unsubscribe();
        }
      });

      // Navigation
      showSignup.addEventListener('click', () => {
        loginCard.style.display = 'none';
        signupCard.style.display = 'block';
      });

      showLogin.addEventListener('click', () => {
        signupCard.style.display = 'none';
        loginCard.style.display = 'block';
      });

      // Check session on load
      supabase.auth.getSession().then(({ data }) => {
        if (data.session) {
          currentUser = data.session.user;
          loadUserData();
        }
      });
    })();
  </script>
</body>
</html>
