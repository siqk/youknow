<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EXILED</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{height:100vh;background:url('https://i.pinimg.com/originals/3f/7a/f8/3f7af8b97413964df82f69bfea89a19c.gif') center/cover no-repeat fixed;display:flex;justify-content:center;align-items:center;color:white;}
.card{background:rgba(0,0,0,0.85);border:1px solid rgba(255,255,255,0.1);border-radius:25px;padding:50px 40px;width:400px;max-width:95%;backdrop-filter:blur(4px);animation:fadeIn .6s ease;}
.logo{text-align:center;font-size:2.3rem;font-weight:800;letter-spacing:6px;margin-bottom:35px;}
input{width:100%;padding:14px;margin-bottom:20px;background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,0.4);color:white;font-size:1rem;outline:none;}
button{width:100%;padding:14px;border:1px solid white;border-radius:30px;background:transparent;color:white;font-weight:600;cursor:pointer;transition:.3s;}
button:hover{background:white;color:black;}
.link{text-align:center;margin-top:20px;font-size:.85rem;color:rgba(255,255,255,0.6);cursor:pointer;}
.link:hover{color:white;}
.dashboard{display:none;text-align:center;width:100%;max-width:600px;}
.nav{display:flex;justify-content:center;margin-bottom:20px;}
.nav button{flex:1;margin:0 5px;}
.page{display:none;}
.page.active{display:block;}
.profile-pic{width:100px;height:100px;border-radius:50%;border:2px solid white;margin:0 auto 20px;object-fit:cover;}
.status{text-align:center;font-size:.85rem;margin-top:10px;color:#ccc;}
.public-profile{display:none;text-align:center;width:100%;max-width:600px;}
.public-profile .profile-pic{margin-bottom:20px;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="card" id="loginCard">
    <div class="logo">EXILED</div>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button onclick="login()">ENTER</button>
    <div class="link" onclick="toggleForm()">Create Account</div>
    <div class="status" id="loginStatus"></div>
</div>

<!-- SIGNUP -->
<div class="card" id="signupCard" style="display:none;">
    <div class="logo">EXILED</div>
    <input type="email" id="signupEmail" placeholder="Email">
    <input type="password" id="signupPassword" placeholder="Password">
    <input type="text" id="signupUsername" placeholder="Choose a username">
    <button onclick="signup()">CREATE</button>
    <div class="link" onclick="toggleForm()">Back to Login</div>
    <div class="status" id="signupStatus"></div>
</div>

<!-- DASHBOARD -->
<div class="dashboard card" id="dashboard">
    <div class="logo">EXILED</div>
    <div class="profile-pic-wrapper">
        <img src="" class="profile-pic" id="profileImage">
    </div>
    <div class="nav">
        <button onclick="showPage('home')">Home</button>
        <button onclick="showPage('profile')">Profile</button>
    </div>
    <div class="page" id="home">
        <h2>Welcome, <span id="displayUsername"></span>!</h2>
        <p>Your vanity URL: <span id="vanityURL"></span></p>
    </div>
    <div class="page" id="profile">
        <h3>Edit Profile</h3>
        <input type="text" id="newUsername" placeholder="Change username">
        <input type="text" id="newAvatar" placeholder="Avatar image URL">
        <button onclick="updateProfile()">Update Profile</button>
        <div class="status" id="profileStatus"></div>
    </div>
    <button onclick="logout()">LOGOUT</button>
</div>

<!-- PUBLIC PROFILE -->
<div class="public-profile card" id="publicProfile">
    <div class="logo">EXILED</div>
    <img src="" class="profile-pic" id="publicAvatar">
    <h2 id="publicUsername"></h2>
    <p id="publicVanityURL"></p>
</div>

<script>
// Supabase
const supabase = window.supabase.createClient(
    "https://opixidygpndbfuisjkrk.supabase.co",
    "sb_publishable_N6RdTgjgUHQbdtvPX9uPqA_VTraUegI"
);

// Toggle login/signup
function toggleForm(){
    loginCard.style.display = loginCard.style.display==="none"?"block":"none";
    signupCard.style.display = signupCard.style.display==="none"?"block":"none";
}

// Pages
function showPage(page){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(page).classList.add('active');}

// Signup
async function signup(){
    signupStatus.innerText="Creating account...";
    const email = signupEmail.value;
    const password = signupPassword.value;
    const username = signupUsername.value.trim().toLowerCase();
    if(!username){signupStatus.innerText="Enter a username";return;}
    let { data: existing } = await supabase.from('profiles').select('username').eq('username', username).single();
    if(existing){signupStatus.innerText="Username taken!"; return;}
    const { error, data } = await supabase.auth.signUp({ email, password });
    if(error){signupStatus.innerText = error.message; return;}
    await supabase.from('profiles').insert([{id:data.user.id, username:username, avatar_url:""}]);
    signupStatus.innerText="Account created! Login now.";
}

// Login
async function login(){
    loginStatus.innerText="Logging in...";
    const email = loginEmail.value;
    const password = loginPassword.value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){loginStatus.innerText = error.message; return;}
    loadDashboard(data.user);
}

// Load dashboard
async function loadDashboard(user){
    loginCard.style.display="none";
    signupCard.style.display="none";
    dashboard.style.display="block";
    showPage('home');
    let { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
    displayUsername.innerText = profile.username;
    vanityURL.innerText = `exiled.lat/${profile.username}`;
    profileImage.src = profile.avatar_url || "https://i.imgur.com/3GvwNBf.png";
    newUsername.value = profile.username;
    newAvatar.value = profile.avatar_url || "";
}

// Update profile
async function updateProfile(){
    profileStatus.innerText="Updating...";
    let username = newUsername.value.trim().toLowerCase();
    let avatar = newAvatar.value;
    let { data: user } = await supabase.auth.getUser();
    let { data: existing } = await supabase.from('profiles').select('username').eq('username', username).single();
    if(existing && existing.id!==user.id){profileStatus.innerText="Username taken!"; return;}
    await supabase.from('profiles').update({username, avatar_url:avatar}).eq('id', user.id);
    profileStatus.innerText="Updated!";
    loadDashboard(user);
}

// Logout
async function logout(){
    await supabase.auth.signOut();
    dashboard.style.display="none";
    loginCard.style.display="block";
}

// Auto session
supabase.auth.getSession().then(({ data })=>{
    if(data.session){loadDashboard(data.session.user);}
});

// PUBLIC PROFILE ROUTING
async function loadPublicProfile(username){
    loginCard.style.display="none";
    signupCard.style.display="none";
    dashboard.style.display="none";
    publicProfile.style.display="block";
    const { data: profile } = await supabase.from('profiles').select('*').eq('username', username).single();
    if(profile){
        publicUsername.innerText = profile.username;
        publicAvatar.src = profile.avatar_url || "https://i.imgur.com/3GvwNBf.png";
        publicVanityURL.innerText = `exiled.lat/${profile.username}`;
    } else {
        publicUsername.innerText = "User not found";
        publicAvatar.src = "https://i.imgur.com/3GvwNBf.png";
        publicVanityURL.innerText = "";
    }
}

// Detect URL path
const path = window.location.pathname.slice(1).toLowerCase();
if(path){loadPublicProfile(path);}
</script>

</body>
</html>
