<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>exiled ¬∑ flex your profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body, html {
      width: 100%;
      min-height: 100vh;
      background: url('https://i.pinimg.com/originals/f2/f3/93/f2f393327208542afade5799bcd3814a.gif') center/cover fixed;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(10px);
      z-index: 0;
      animation: fadeBlur 1s ease-out;
    }

    @keyframes fadeBlur {
      0% { backdrop-filter: blur(0px); background: rgba(0,0,0,0.3); }
      100% { backdrop-filter: blur(10px); background: rgba(0,0,0,0.75); }
    }

    .container {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 1300px;
      padding: 20px;
      animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
      0% { opacity: 0; transform: translateY(50px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .glass-card {
      background: rgba(15, 15, 15, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 30px;
      padding: 35px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.9);
      transition: all 0.4s;
    }

    .glass-card:hover {
      border-color: rgba(255,255,255,0.2);
    }

    .auth-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80vh;
    }

    .auth-card {
      width: 450px;
      max-width: 100%;
      animation: popIn 0.6s ease;
    }

    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.9) translateY(20px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    h1 {
      font-size: 4rem;
      font-weight: 700;
      letter-spacing: 8px;
      text-align: center;
      background: linear-gradient(135deg, #fff, #aaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 30px;
      filter: drop-shadow(0 4px 20px black);
    }

    .input-group {
      margin: 20px 0;
      position: relative;
    }

    .input-group input, .input-group textarea {
      width: 100%;
      background: rgba(255,255,255,0.07);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 50px;
      padding: 18px 25px;
      font-size: 1rem;
      color: white;
      outline: none;
      transition: all 0.3s;
    }

    .input-group textarea {
      border-radius: 25px;
      resize: vertical;
      min-height: 100px;
    }

    .input-group input:focus, .input-group textarea:focus {
      border-color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.12);
      transform: scale(1.02);
    }

    .input-group label {
      position: absolute;
      left: 25px;
      top: 18px;
      color: #aaa;
      transition: 0.3s;
      pointer-events: none;
      background: transparent;
      padding: 0 8px;
    }

    .input-group input:focus ~ label,
    .input-group input:not(:placeholder-shown) ~ label,
    .input-group textarea:focus ~ label,
    .input-group textarea:not(:placeholder-shown) ~ label {
      top: -12px;
      left: 20px;
      font-size: 0.8rem;
      color: white;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      border-radius: 20px;
      padding: 4px 15px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .btn {
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 50px;
      padding: 18px 30px;
      font-weight: 600;
      font-size: 1.1rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px 0;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
      border-color: rgba(255,255,255,0.4);
      transform: translateY(-3px);
      box-shadow: 0 15px 30px -10px black;
    }

    .link {
      color: #aaa;
      text-align: center;
      display: block;
      margin-top: 20px;
      cursor: pointer;
      transition: 0.3s;
    }

    .link:hover {
      color: white;
      transform: translateX(5px);
    }

    .message {
      min-height: 30px;
      color: #ffd966;
      text-align: center;
      font-size: 0.9rem;
      margin: 10px 0;
    }

    /* Dashboard Styles */
    .dashboard {
      display: none;
    }

    .dash-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 60px;
    }

    .nav-links {
      display: flex;
      gap: 15px;
    }

    .nav-btn {
      background: transparent;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 40px;
      padding: 12px 25px;
      color: white;
      cursor: pointer;
      transition: 0.3s;
      font-size: 0.95rem;
    }

    .nav-btn:hover, .nav-btn.active {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.3);
    }

    .user-badge {
      background: rgba(255,255,255,0.1);
      padding: 12px 25px;
      border-radius: 40px;
      border: 1px solid rgba(255,255,255,0.2);
      font-weight: 500;
    }

    .dash-content {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 25px;
    }

    /* Profile Sidebar */
    .profile-sidebar {
      background: rgba(0,0,0,0.3);
      border-radius: 30px;
      padding: 25px;
      text-align: center;
    }

    .avatar {
      width: 150px;
      height: 150px;
      margin: 0 auto 20px;
      position: relative;
      cursor: pointer;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.2);
      object-fit: cover;
    }

    .avatar-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: 0.3s;
    }

    .avatar:hover .avatar-overlay {
      opacity: 1;
    }

    .avatar-overlay i {
      font-size: 2rem;
      color: white;
    }

    .avatar-input {
      display: none;
    }

    .profile-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 30px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #ffd700;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #aaa;
    }

    /* Main Content Area */
    .main-content {
      background: rgba(0,0,0,0.3);
      border-radius: 30px;
      padding: 30px;
    }

    .edit-section {
      display: none;
    }

    .edit-section.active {
      display: block;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 25px;
      color: #ffd700;
    }

    .social-links {
      display: grid;
      gap: 15px;
    }

    .social-input {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 50px;
      padding: 5px 5px 5px 20px;
    }

    .social-input i {
      font-size: 1.2rem;
      color: #aaa;
      width: 25px;
    }

    .social-input input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 15px;
      color: white;
      outline: none;
    }

    .save-btn {
      width: auto;
      padding: 15px 40px;
      margin-top: 20px;
    }

    /* Username Grid */
    .username-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .user-card {
      background: rgba(30,30,30,0.6);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      animation: cardAppear 0.5s;
    }

    @keyframes cardAppear {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .user-card:hover {
      transform: translateY(-5px) scale(1.02);
      border-color: rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
    }

    .user-card.highlight {
      border: 2px solid #ffd700;
      background: rgba(255,215,0,0.1);
    }

    .user-avatar-small {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin: 0 auto 10px;
      border: 2px solid rgba(255,255,255,0.2);
      object-fit: cover;
    }

    /* Profile View */
    .profile-view {
      display: none;
      text-align: center;
    }

    .profile-header {
      margin-bottom: 30px;
    }

    .profile-avatar-large {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      margin: 0 auto 20px;
      border: 4px solid #ffd700;
      object-fit: cover;
    }

    .profile-bio {
      max-width: 500px;
      margin: 20px auto;
      color: #aaa;
      line-height: 1.6;
    }

    .profile-socials {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
    }

    .profile-socials a {
      color: white;
      font-size: 1.5rem;
      transition: 0.3s;
    }

    .profile-socials a:hover {
      color: #ffd700;
      transform: translateY(-3px);
    }

    .profile-url {
      background: rgba(0,0,0,0.3);
      padding: 15px 25px;
      border-radius: 50px;
      display: inline-block;
      margin: 20px 0;
    }

    .back-btn {
      width: auto;
      padding: 15px 40px;
      margin-top: 20px;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2rem;
      color: #aaa;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 15px 25px;
      border-radius: 50px;
      border-left: 4px solid #ffd700;
      animation: slideIn 0.3s;
      z-index: 1000;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .not-found {
      text-align: center;
      padding: 60px;
    }

    .not-found i {
      font-size: 4rem;
      color: #ffd700;
      margin-bottom: 20px;
    }

    .logout-btn {
      background: rgba(255,0,0,0.2);
      border-color: rgba(255,0,0,0.3);
    }

    .logout-btn:hover {
      background: rgba(255,0,0,0.3);
      border-color: rgba(255,0,0,0.5);
    }
  </style>
</head>
<body>
<div class="overlay"></div>
<div class="container">

  <!-- LOADING STATE -->
  <div id="loadingState" class="loading" style="display: none;">
    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 20px;"></i>
    <h2>loading exile...</h2>
  </div>

  <!-- NOT FOUND STATE -->
  <div id="notFoundView" class="profile-view">
    <div class="glass-card" style="max-width: 600px; margin: 0 auto;">
      <div class="not-found">
        <i class="fas fa-user-slash"></i>
        <h2>exile not found</h2>
        <p style="color: #aaa; margin: 20px 0;">the username you're looking for doesn't exist</p>
        <button class="btn" id="backToHomeFromNotFound">‚Üê back to home</button>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="auth-wrapper">
    <div class="glass-card auth-card">
      <h1>EXILED</h1>
      <div class="input-group">
        <input type="email" id="loginEmail" placeholder=" ">
        <label>email</label>
      </div>
      <div class="input-group">
        <input type="password" id="loginPassword" placeholder=" ">
        <label>password</label>
      </div>
      <button class="btn" id="loginBtn">log in</button>
      <div class="message" id="loginMessage"></div>
      <span class="link" id="switchToSignup">no account? sign up ‚Üí</span>
    </div>
  </div>

  <!-- SIGNUP -->
  <div id="signupCard" class="auth-wrapper" style="display: none;">
    <div class="glass-card auth-card">
      <h1>EXILED</h1>
      <div class="input-group">
        <input type="text" id="signupUsername" placeholder=" ">
        <label>username</label>
      </div>
      <div class="input-group">
        <input type="email" id="signupEmail" placeholder=" ">
        <label>email</label>
      </div>
      <div class="input-group">
        <input type="password" id="signupPassword" placeholder=" ">
        <label>password</label>
      </div>
      <button class="btn" id="signupBtn">sign up & flex</button>
      <div class="message" id="signupMessage"></div>
      <span class="link" id="switchToLogin">‚Üê back to login</span>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="dashboard">
    <div class="glass-card">
      <div class="dash-nav">
        <div class="nav-links">
          <button class="nav-btn active" data-section="profile">my profile</button>
          <button class="nav-btn" data-section="edit">edit profile</button>
          <button class="nav-btn" data-section="social">social links</button>
          <button class="nav-btn" data-section="explore">explore</button>
        </div>
        <div class="user-badge" id="currentUserBadge">@loading</div>
      </div>

      <div class="dash-content">
        <!-- Sidebar -->
        <div class="profile-sidebar">
          <div class="avatar" id="avatarUpload">
            <img id="profileAvatar" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" alt="avatar">
            <div class="avatar-overlay">
              <i class="fas fa-camera"></i>
            </div>
            <input type="file" id="avatarInput" class="avatar-input" accept="image/*">
          </div>
          <h2 id="sidebarUsername">@username</h2>
          <p id="sidebarBio" style="color: #aaa; margin: 10px 0;">no bio yet</p>
          
          <div class="profile-stats">
            <div class="stat-item">
              <div class="stat-value" id="statPosts">0</div>
              <div class="stat-label">flexes</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="statViews">0</div>
              <div class="stat-label">views</div>
            </div>
          </div>

          <div class="profile-socials" id="sidebarSocials">
            <!-- Social icons will be added here -->
          </div>

          <button class="btn logout-btn" id="logoutBtn" style="margin-top: 20px;">logout</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
          <!-- Profile Section -->
          <div id="profileSection" class="edit-section active">
            <h3 class="section-title">your profile</h3>
            <div style="text-align: center; padding: 40px;">
              <i class="fas fa-user-circle" style="font-size: 5rem; color: #ffd700; margin-bottom: 20px;"></i>
              <p style="color: #aaa; margin-bottom: 20px;">this is how others see you</p>
              <div class="profile-url" id="profileUrlDisplay" style="cursor: pointer;" onclick="copyProfileUrl()">
                <i class="fas fa-link"></i> exiled.lat/<span id="profileSlug">username</span>
              </div>
            </div>
          </div>

          <!-- Edit Profile Section -->
          <div id="editSection" class="edit-section">
            <h3 class="section-title">edit profile</h3>
            <div class="input-group">
              <input type="text" id="editUsername" placeholder=" ">
              <label>username</label>
            </div>
            <div class="input-group">
              <textarea id="editBio" placeholder=" " rows="4"></textarea>
              <label>bio</label>
            </div>
            <button class="btn save-btn" id="saveProfileBtn">save changes</button>
          </div>

          <!-- Social Links Section -->
          <div id="socialSection" class="edit-section">
            <h3 class="section-title">social links</h3>
            <div class="social-links">
              <div class="social-input">
                <i class="fab fa-github"></i>
                <input type="text" id="githubLink" placeholder="github username">
              </div>
              <div class="social-input">
                <i class="fab fa-twitter"></i>
                <input type="text" id="twitterLink" placeholder="twitter username">
              </div>
              <div class="social-input">
                <i class="fab fa-instagram"></i>
                <input type="text" id="instagramLink" placeholder="instagram username">
              </div>
              <div class="social-input">
                <i class="fab fa-linkedin"></i>
                <input type="text" id="linkedinLink" placeholder="linkedin username">
              </div>
              <div class="social-input">
                <i class="fas fa-globe"></i>
                <input type="text" id="websiteLink" placeholder="your website">
              </div>
            </div>
            <button class="btn save-btn" id="saveSocialBtn">save social links</button>
          </div>

          <!-- Explore Section -->
          <div id="exploreSection" class="edit-section">
            <h3 class="section-title">explore exiles</h3>
            <div class="username-grid" id="usernameList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE VIEW (Public) -->
  <div id="profileView" class="profile-view">
    <div class="glass-card" style="max-width: 800px; margin: 0 auto;">
      <img id="viewAvatar" class="profile-avatar-large" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" alt="avatar">
      <h1 id="viewUsername" class="big-username" style="font-size: 4rem;">@username</h1>
      <p id="viewBio" class="profile-bio">no bio yet</p>
      
      <div class="profile-socials" id="viewSocials">
        <!-- Social icons will be added here -->
      </div>
      
      <div class="profile-url">
        <i class="fas fa-link"></i> exiled.lat/<span id="viewSlug">username</span>
      </div>
      
      <button class="btn back-btn" id="backFromProfile">‚Üê back to explore</button>
    </div>
  </div>

</div>

<script>
  (function() {
    // Supabase setup
    const SUPABASE_URL = "https://opixidygpndbfuisjkrk.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_N6RdTgjgUHQbdtvPX9uPqA_VTraUegI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    // DOM elements
    const loginCard = document.getElementById('loginCard');
    const signupCard = document.getElementById('signupCard');
    const dashboard = document.getElementById('dashboard');
    const profileView = document.getElementById('profileView');
    const notFoundView = document.getElementById('notFoundView');
    const loadingState = document.getElementById('loadingState');
    
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');
    const loginMessage = document.getElementById('loginMessage');
    
    const signupUsername = document.getElementById('signupUsername');
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const signupBtn = document.getElementById('signupBtn');
    const signupMessage = document.getElementById('signupMessage');
    
    const switchToSignup = document.getElementById('switchToSignup');
    const switchToLogin = document.getElementById('switchToLogin');
    const backToHomeFromNotFound = document.getElementById('backToHomeFromNotFound');
    
    const currentUserBadge = document.getElementById('currentUserBadge');
    const usernameList = document.getElementById('usernameList');
    const logoutBtn = document.getElementById('logoutBtn');
    
    // Profile elements
    const profileAvatar = document.getElementById('profileAvatar');
    const avatarInput = document.getElementById('avatarInput');
    const sidebarUsername = document.getElementById('sidebarUsername');
    const sidebarBio = document.getElementById('sidebarBio');
    const profileSlug = document.getElementById('profileSlug');
    const editUsername = document.getElementById('editUsername');
    const editBio = document.getElementById('editBio');
    
    // Social inputs
    const githubLink = document.getElementById('githubLink');
    const twitterLink = document.getElementById('twitterLink');
    const instagramLink = document.getElementById('instagramLink');
    const linkedinLink = document.getElementById('linkedinLink');
    const websiteLink = document.getElementById('websiteLink');
    
    const sidebarSocials = document.getElementById('sidebarSocials');
    const viewSocials = document.getElementById('viewSocials');
    
    // View profile elements
    const viewAvatar = document.getElementById('viewAvatar');
    const viewUsername = document.getElementById('viewUsername');
    const viewBio = document.getElementById('viewBio');
    const viewSlug = document.getElementById('viewSlug');
    
    const backFromProfile = document.getElementById('backFromProfile');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const saveSocialBtn = document.getElementById('saveSocialBtn');

    // State
    let currentUser = null;
    let currentProfile = null;
    let allUsers = [];
    let authChecked = false;

    // Helper Functions
    function hideAllViews() {
      loginCard.style.display = 'none';
      signupCard.style.display = 'none';
      dashboard.style.display = 'none';
      profileView.style.display = 'none';
      notFoundView.style.display = 'none';
      loadingState.style.display = 'none';
    }

    function showLoading(show) {
      loadingState.style.display = show ? 'block' : 'none';
    }

    function showMessage(element, text, isError = false) {
      element.textContent = text;
      element.style.color = isError ? '#ff9999' : '#ffd966';
      setTimeout(() => { element.textContent = ''; }, 3000);
    }

    function showNotification(text, isError = false) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = text;
      notif.style.background = isError ? 'rgba(255,0,0,0.8)' : 'rgba(0,0,0,0.9)';
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"]/g, function(m) {
        if (m === '&') return '&amp;';
        if (m === '<') return '&lt;';
        if (m === '>') return '&gt;';
        if (m === '"') return '&quot;';
        return m;
      });
    }

    // Copy profile URL
    window.copyProfileUrl = function() {
      if (currentProfile) {
        const text = `exiled.lat/${currentProfile.username}`;
        navigator.clipboard.writeText(text);
        showNotification('‚ú® url copied!');
      }
    };

    // Navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.querySelectorAll('.edit-section').forEach(s => s.classList.remove('active'));
        document.getElementById(btn.dataset.section + 'Section').classList.add('active');
      });
    });

    // Avatar upload
    document.getElementById('avatarUpload').addEventListener('click', () => {
      avatarInput.click();
    });

    avatarInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64 = reader.result;
        profileAvatar.src = base64;
        
        if (currentUser) {
          await supabase
            .from('profiles')
            .update({ avatar_url: base64 })
            .eq('id', currentUser.id);
          showNotification('avatar updated!');
        }
      };
      reader.readAsDataURL(file);
    });

    // Save profile
    saveProfileBtn.addEventListener('click', async () => {
      const newUsername = editUsername.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
      const newBio = editBio.value.trim();
      
      if (!newUsername) {
        showNotification('username cannot be empty', true);
        return;
      }
      
      if (currentUser) {
        // Check if username is taken
        const { data: existing } = await supabase
          .from('profiles')
          .select('username')
          .eq('username', newUsername)
          .neq('id', currentUser.id)
          .maybeSingle();
        
        if (existing) {
          showNotification('username taken', true);
          return;
        }
        
        await supabase
          .from('profiles')
          .update({ 
            username: newUsername,
            bio: newBio
          })
          .eq('id', currentUser.id);
        
        currentProfile.username = newUsername;
        sidebarUsername.textContent = `@${newUsername}`;
        currentUserBadge.textContent = `@${newUsername}`;
        profileSlug.textContent = newUsername;
        
        showNotification('profile updated!');
        await fetchAllUsers();
      }
    });

    // Save social links
    saveSocialBtn.addEventListener('click', async () => {
      const socials = {
        github: githubLink.value.trim(),
        twitter: twitterLink.value.trim(),
        instagram: instagramLink.value.trim(),
        linkedin: linkedinLink.value.trim(),
        website: websiteLink.value.trim()
      };
      
      await supabase
        .from('profiles')
        .update({ socials })
        .eq('id', currentUser.id);
      
      currentProfile.socials = socials;
      updateSocialIcons(socials);
      showNotification('social links updated!');
    });

    function updateSocialIcons(socials) {
      sidebarSocials.innerHTML = '';
      
      const platforms = ['github', 'twitter', 'instagram', 'linkedin', 'website'];
      platforms.forEach(platform => {
        if (socials && socials[platform]) {
          const icon = document.createElement('a');
          icon.href = platform === 'website' ? socials[platform] : `https://${platform}.com/${socials[platform]}`;
          icon.target = '_blank';
          icon.innerHTML = `<i class="fab fa-${platform === 'website' ? 'globe' : platform}"></i>`;
          sidebarSocials.appendChild(icon);
        }
      });
    }

    // Load user data
    async function loadUserData(user) {
      const { data: profile, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .maybeSingle();
      
      if (profile) {
        currentProfile = profile;
        sidebarUsername.textContent = `@${profile.username}`;
        sidebarBio.textContent = profile.bio || 'no bio yet';
        profileSlug.textContent = profile.username;
        editUsername.value = profile.username;
        editBio.value = profile.bio || '';
        
        if (profile.avatar_url) {
          profileAvatar.src = profile.avatar_url;
        }
        
        if (profile.socials) {
          githubLink.value = profile.socials.github || '';
          twitterLink.value = profile.socials.twitter || '';
          instagramLink.value = profile.socials.instagram || '';
          linkedinLink.value = profile.socials.linkedin || '';
          websiteLink.value = profile.socials.website || '';
          updateSocialIcons(profile.socials);
        }
      }
      return profile;
    }

    // Fetch all users for explore
    async function fetchAllUsers() {
      const { data, error } = await supabase
        .from('profiles')
        .select('id, username, avatar_url, bio')
        .order('username');
      
      if (error) {
        console.error('Fetch error:', error);
        return [];
      }
      
      allUsers = data || [];
      renderUserGrid();
      return allUsers;
    }

    function renderUserGrid() {
      if (!allUsers.length) {
        usernameList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">üåÄ no exiles yet</div>';
        return;
      }
      
      let html = '';
      allUsers.forEach(user => {
        const isYou = currentUser && user.id === currentUser.id;
        html += `<div class="user-card ${isYou ? 'highlight' : ''}" data-username="${escapeHtml(user.username)}">
          <img src="${user.avatar_url || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y'}" class="user-avatar-small">
          <div>@${escapeHtml(user.username)}</div>
          <small style="color: #aaa;">${user.bio ? user.bio.substring(0, 30) + '...' : ''}</small>
        </div>`;
      });
      
      usernameList.innerHTML = html;
      
      document.querySelectorAll('.user-card').forEach(card => {
        card.addEventListener('click', () => {
          const username = card.dataset.username;
          if (username) {
            window.history.pushState({}, '', `/${username}`);
            showUserProfile(username);
          }
        });
      });
    }

    // Show public user profile
    async function showUserProfile(username) {
      showLoading(true);
      hideAllViews();
      
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('username', username)
        .maybeSingle();
      
      showLoading(false);
      
      if (data && !error) {
        viewAvatar.src = data.avatar_url || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';
        viewUsername.textContent = `@${data.username}`;
        viewBio.textContent = data.bio || 'no bio yet';
        viewSlug.textContent = data.username;
        
        viewSocials.innerHTML = '';
        if (data.socials) {
          const platforms = ['github', 'twitter', 'instagram', 'linkedin', 'website'];
          platforms.forEach(platform => {
            if (data.socials[platform]) {
              const icon = document.createElement('a');
              icon.href = platform === 'website' ? data.socials[platform] : `https://${platform}.com/${data.socials[platform]}`;
              icon.target = '_blank';
              icon.innerHTML = `<i class="fab fa-${platform === 'website' ? 'globe' : platform}"></i>`;
              viewSocials.appendChild(icon);
            }
          });
        }
        
        profileView.style.display = 'block';
      } else {
        notFoundView.style.display = 'block';
      }
    }

    // Handle public profile routes
    async function handlePublicProfile() {
      const path = window.location.pathname;
      const username = path.substring(1); // Remove leading '/'
      
      // If it's the root path or index.html
      if (path === '/' || path === '/index.html' || path === '') {
        return false;
      }
      
      // Check if it's a valid username (no slashes, dots, etc.)
      if (username && !username.includes('/') && !username.includes('.') && username.length > 0) {
        showLoading(true);
        hideAllViews();
        
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('username', username)
          .maybeSingle();
        
        showLoading(false);
        
        if (data && !error) {
          viewAvatar.src = data.avatar_url || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';
          viewUsername.textContent = `@${data.username}`;
          viewBio.textContent = data.bio || 'no bio yet';
          viewSlug.textContent = data.username;
          
          viewSocials.innerHTML = '';
          if (data.socials) {
            const platforms = ['github', 'twitter', 'instagram', 'linkedin', 'website'];
            platforms.forEach(platform => {
              if (data.socials[platform]) {
                const icon = document.createElement('a');
                icon.href = platform === 'website' ? data.socials[platform] : `https://${platform}.com/${data.socials[platform]}`;
                icon.target = '_blank';
                icon.innerHTML = `<i class="fab fa-${platform === 'website' ? 'globe' : platform}"></i>`;
                viewSocials.appendChild(icon);
              }
            });
          }
          
          profileView.style.display = 'block';
          return true;
        } else {
          notFoundView.style.display = 'block';
          return true;
        }
      }
      return false;
    }

    // Login
    loginBtn.addEventListener('click', async () => {
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();
      
      if (!email || !password) {
        showMessage(loginMessage, 'fill all fields', true);
        return;
      }
      
      showLoading(true);
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      showLoading(false);
      
      if (error) {
        showMessage(loginMessage, error.message, true);
        return;
      }
      
      currentUser = data.user;
      await loadUserData(currentUser);
      await fetchAllUsers();
      
      currentUserBadge.textContent = `@${currentProfile.username}`;
      
      hideAllViews();
      dashboard.style.display = 'block';
      showNotification(`welcome back, @${currentProfile.username}!`);
    });

    // Signup
    signupBtn.addEventListener('click', async () => {
      const username = signupUsername.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = signupEmail.value.trim();
      const password = signupPassword.value.trim();
      
      if (!username || !email || !password) {
        showMessage(signupMessage, 'all fields required', true);
        return;
      }
      
      if (username.length < 3) {
        showMessage(signupMessage, 'username must be at least 3 characters', true);
        return;
      }
      
      showLoading(true);
      
      // Check if username exists
      const { data: existing } = await supabase
        .from('profiles')
        .select('username')
        .eq('username', username)
        .maybeSingle();
      
      if (existing) {
        showLoading(false);
        showMessage(signupMessage, 'username taken', true);
        return;
      }
      
      const { data, error } = await supabase.auth.signUp({ 
        email, 
        password,
        options: {
          data: { username }
        }
      });
      
      if (error) {
        showLoading(false);
        showMessage(signupMessage, error.message, true);
        return;
      }
      
      if (data.user) {
        // Create profile
        await supabase
          .from('profiles')
          .insert({ 
            id: data.user.id, 
            username, 
            bio: '', 
            socials: {},
            avatar_url: null
          });
        
        // Auto login
        const { data: loginData } = await supabase.auth.signInWithPassword({ email, password });
        showLoading(false);
        
        if (loginData.user) {
          currentUser = loginData.user;
          await loadUserData(currentUser);
          await fetchAllUsers();
          
          currentUserBadge.textContent = `@${username}`;
          hideAllViews();
          dashboard.style.display = 'block';
          showNotification(`welcome to exile, @${username}!`);
        }
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      currentUser = null;
      currentProfile = null;
      hideAllViews();
      loginCard.style.display = 'flex';
      window.history.pushState({}, '', '/');
      showNotification('logged out');
    });

    // Navigation
    switchToSignup.addEventListener('click', () => {
      loginCard.style.display = 'none';
      signupCard.style.display = 'flex';
    });

    switchToLogin.addEventListener('click', () => {
      signupCard.style.display = 'none';
      loginCard.style.display = 'flex';
    });

    backFromProfile.addEventListener('click', async () => {
      window.history.pushState({}, '', '/');
      const { data } = await supabase.auth.getSession();
      hideAllViews();
      if (data.session) {
        dashboard.style.display = 'block';
      } else {
        loginCard.style.display = 'flex';
      }
    });

    backToHomeFromNotFound.addEventListener('click', async () => {
      window.history.pushState({}, '', '/');
      const { data } = await supabase.auth.getSession();
      hideAllViews();
      if (data.session) {
        dashboard.style.display = 'block';
      } else {
        loginCard.style.display = 'flex';
      }
    });

    // Handle browser back/forward
    window.addEventListener('popstate', async () => {
      const handled = await handlePublicProfile();
      if (!handled) {
        const { data } = await supabase.auth.getSession();
        hideAllViews();
        if (data.session) {
          dashboard.style.display = 'block';
        } else {
          loginCard.style.display = 'flex';
        }
      }
    });

    // Initialize
    async function init() {
      showLoading(true);
      
      // First check if it's a public profile URL
      const publicProfileHandled = await handlePublicProfile();
      if (publicProfileHandled) {
        showLoading(false);
        return;
      }
      
      // Check auth session
      const { data } = await supabase.auth.getSession();
      
      if (data.session) {
        currentUser = data.session.user;
        await loadUserData(currentUser);
        await fetchAllUsers();
        currentUserBadge.textContent = `@${currentProfile?.username || 'user'}`;
        hideAllViews();
        dashboard.style.display = 'block';
      } else {
        hideAllViews();
        loginCard.style.display = 'flex';
      }
      
      showLoading(false);
    }

    init();
  })();
</script>
</body>
</html>
