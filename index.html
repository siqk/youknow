<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>exiled - anonymous pastebin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #000;
      color: #ccc;
      font-family: Arial, sans-serif;
    }

    /* NAVBAR */
    .navbar {
      background: #0d0d0d;
      border-bottom: 1px solid #222;
      padding: 12px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-left a {
      color: #aaa;
      margin-right: 25px;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .nav-left a:hover {
      color: #fff;
    }

    .nav-left a.active {
      color: #fff;
      border-bottom: 1px solid #fff;
      padding-bottom: 3px;
    }

    .nav-right {
      font-size: 13px;
      color: #0f0;
      display: flex;
      gap: 15px;
    }

    .nav-right span {
      cursor: pointer;
      transition: color 0.2s;
    }

    .nav-right span:hover {
      color: #fff;
    }

    /* HERO SECTION */
    .hero {
      text-align: center;
      padding: 40px 20px 20px;
    }

    .logo {
      font-size: 48px;
      font-weight: bold;
      color: #fff;
      margin-bottom: 10px;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(255,255,255,0.3);
    }

    .hero p {
      color: #888;
      font-size: 14px;
    }

    /* SEARCH */
    .search-box {
      margin-top: 20px;
    }

    .search-box input[type="text"] {
      background: #111;
      border: 1px solid #333;
      padding: 10px;
      width: 250px;
      color: #fff;
      border-radius: 4px;
    }

    .search-box input[type="text"]:focus {
      outline: none;
      border-color: #0f0;
    }

    .search-box button {
      background: #222;
      border: 1px solid #444;
      padding: 10px 15px;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .search-box button:hover {
      background: #333;
      border-color: #0f0;
    }

    .radio-options {
      margin-top: 10px;
      font-size: 13px;
      color: #888;
    }

    .radio-options label {
      margin: 0 10px;
      cursor: pointer;
    }

    /* CONTENT */
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 30px auto;
    }

    h2 {
      color: #fff;
      border-bottom: 1px solid #222;
      padding-bottom: 10px;
      font-size: 18px;
      font-weight: normal;
      margin-bottom: 15px;
    }

    /* TABLE */
    .table-responsive {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th {
      background: #111;
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #333;
      font-size: 13px;
      color: #888;
      font-weight: normal;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #222;
      font-size: 13px;
    }

    tr:hover td {
      background: #111;
    }

    .title {
      color: #fff;
      cursor: pointer;
      transition: color 0.2s;
    }

    .title:hover {
      color: #0f0;
      text-decoration: underline;
    }

    .views {
      color: #0f0;
    }

    .username-blue {
      color: #4a9eff;
    }

    .username-white {
      color: #fff;
      font-weight: bold;
    }

    .rich-badge {
      color: #ffd700;
      font-weight: bold;
      margin-left: 3px;
      font-size: 11px;
    }

    .comment-count {
      color: #888;
    }

    .date {
      color: #888;
    }

    /* PAGINATION */
    .pagination {
      text-align: center;
      margin-top: 25px;
    }

    .pagination a {
      display: inline-block;
      padding: 6px 12px;
      margin: 0 3px;
      background: #111;
      color: #aaa;
      border: 1px solid #333;
      text-decoration: none;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .pagination a:hover {
      background: #222;
      border-color: #0f0;
      color: #fff;
    }

    /* CREATE PASTE */
    .create-paste {
      background: #111;
      border: 1px solid #222;
      padding: 20px;
      border-radius: 6px;
    }

    .create-paste input,
    .create-paste textarea {
      width: 100%;
      background: #000;
      border: 1px solid #333;
      padding: 12px;
      color: #fff;
      margin: 10px 0;
      border-radius: 4px;
      font-family: Arial, sans-serif;
    }

    .create-paste textarea {
      min-height: 200px;
      font-family: monospace;
      resize: vertical;
    }

    .create-paste input:focus,
    .create-paste textarea:focus {
      outline: none;
      border-color: #0f0;
    }

    .create-paste button {
      background: #222;
      border: 1px solid #444;
      padding: 12px 20px;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .create-paste button:hover {
      background: #333;
      border-color: #0f0;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #888;
      margin: 10px 0;
      cursor: pointer;
    }

    /* PROFILE PAGE */
    .profile-view {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
    }

    .profile-left {
      background: #111;
      border: 1px solid #222;
      padding: 20px;
      border-radius: 6px;
    }

    .profile-avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 2px solid #333;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: #888;
      background: #1a1a1a;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      transition: border-color 0.2s;
    }

    .profile-avatar-large:hover {
      border-color: #0f0;
    }

    .profile-avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-avatar-large:hover::after {
      content: 'Change';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      text-align: center;
      padding: 5px;
      font-size: 11px;
    }

    .profile-username-large {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
    }

    .profile-uid {
      color: #888;
      font-size: 11px;
      text-align: center;
      margin-bottom: 15px;
    }

    .profile-stats {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      padding: 10px 0;
      border-top: 1px solid #222;
      border-bottom: 1px solid #222;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      color: #0f0;
      font-weight: bold;
    }

    .stat-label {
      font-size: 10px;
      color: #888;
    }

    .profile-bio {
      border: 1px solid #222;
      padding: 12px;
      margin: 15px 0;
      min-height: 60px;
      font-size: 12px;
      border-radius: 4px;
      word-break: break-word;
    }

    .profile-right {
      background: #111;
      border: 1px solid #222;
      padding: 20px;
      border-radius: 6px;
    }

    .profile-tabs {
      display: flex;
      gap: 20px;
      border-bottom: 1px solid #222;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .profile-tab {
      cursor: pointer;
      color: #888;
      font-size: 13px;
      transition: color 0.2s;
    }

    .profile-tab:hover {
      color: #fff;
    }

    .profile-tab.active {
      color: #fff;
      border-bottom: 2px solid #0f0;
    }

    .share-url {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }

    .share-url input {
      flex: 1;
      background: #000;
      border: 1px solid #333;
      padding: 8px;
      color: #888;
      font-size: 11px;
      border-radius: 4px;
    }

    .share-url button {
      padding: 8px 12px;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .share-url button:hover {
      background: #333;
      border-color: #0f0;
    }

    .gif-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ffd700;
      color: #000;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: bold;
    }

    /* EDIT FORM */
    .edit-form {
      margin-top: 15px;
    }

    .edit-form input,
    .edit-form textarea {
      width: 100%;
      background: #000;
      border: 1px solid #333;
      padding: 10px;
      color: #fff;
      margin: 5px 0;
      border-radius: 4px;
    }

    .edit-form textarea {
      min-height: 60px;
      resize: vertical;
    }

    .edit-form input:focus,
    .edit-form textarea:focus {
      outline: none;
      border-color: #0f0;
    }

    .edit-form button {
      width: 100%;
      padding: 10px;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
      margin: 5px 0;
      transition: all 0.2s;
    }

    .edit-form button.primary {
      background: #0f0;
      color: #000;
      border: none;
      font-weight: bold;
    }

    .edit-form button.primary:hover {
      background: #00cc00;
    }

    .edit-form button:hover {
      background: #333;
    }

    /* USERS GRID */
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }

    .user-card {
      background: #111;
      border: 1px solid #222;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .user-card:hover {
      border-color: #0f0;
      transform: translateY(-2px);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #1a1a1a;
      border: 1px solid #333;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #888;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-name {
      font-weight: bold;
      margin-bottom: 5px;
      word-break: break-word;
    }

    .user-joined {
      color: #888;
      font-size: 11px;
    }

    .gif-tag {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ffd700;
      color: #000;
      font-size: 9px;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* PASTE VIEW */
    .paste-view {
      background: #111;
      border: 1px solid #222;
      padding: 25px;
      border-radius: 6px;
    }

    .paste-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #222;
      flex-wrap: wrap;
      gap: 10px;
    }

    .paste-title {
      font-size: 24px;
      color: #fff;
      word-break: break-word;
    }

    .paste-meta {
      display: flex;
      gap: 20px;
      color: #888;
      flex-wrap: wrap;
    }

    .paste-content {
      border: 1px solid #222;
      padding: 20px;
      min-height: 200px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 20px 0;
      background: #0a0a0a;
      border-radius: 4px;
    }

    .back-btn {
      padding: 8px 15px;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: #333;
      border-color: #0f0;
    }

    /* COMMENTS SECTION */
    .comments-section {
      margin-top: 30px;
    }

    .comment {
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      color: #888;
      font-size: 12px;
    }

    .comment-author {
      color: #fff;
      font-weight: bold;
    }

    .comment-content {
      color: #ccc;
      font-size: 13px;
      line-height: 1.5;
    }

    .comment-input {
      width: 100%;
      background: #000;
      border: 1px solid #333;
      padding: 12px;
      color: #fff;
      margin: 10px 0;
      border-radius: 4px;
      min-height: 80px;
      resize: vertical;
    }

    .comment-btn {
      background: #222;
      border: 1px solid #444;
      padding: 8px 15px;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
    }

    .comment-btn:hover {
      background: #333;
      border-color: #0f0;
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #888;
      border: 1px solid #222;
      background: #111;
      border-radius: 6px;
    }

    /* HIDDEN */
    .hidden {
      display: none !important;
    }

    /* MESSAGES */
    .message {
      padding: 12px;
      border: 1px solid #333;
      margin: 10px 0;
      text-align: center;
      border-radius: 4px;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.success {
      border-color: #0f0;
      color: #0f0;
      background: rgba(0,255,0,0.1);
    }

    .message.error {
      border-color: #ff4444;
      color: #ff4444;
      background: rgba(255,68,68,0.1);
    }

    /* AUTH */
    .auth-box {
      max-width: 400px;
      margin: 40px auto;
      background: #111;
      border: 1px solid #222;
      padding: 30px;
      border-radius: 6px;
    }

    .auth-box h2 {
      text-align: center;
      margin-bottom: 20px;
      border: none;
      color: #fff;
    }

    .auth-box input {
      width: 100%;
      background: #000;
      border: 1px solid #333;
      padding: 12px;
      color: #fff;
      margin: 10px 0;
      border-radius: 4px;
    }

    .auth-box input:focus {
      outline: none;
      border-color: #0f0;
    }

    .auth-box button {
      width: 100%;
      padding: 12px;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
      margin: 5px 0;
      font-size: 14px;
      transition: all 0.2s;
    }

    .auth-box button.primary {
      background: #0f0;
      color: #000;
      border: none;
      font-weight: bold;
    }

    .auth-box button.primary:hover {
      background: #00cc00;
    }

    .auth-box button:hover {
      background: #333;
    }

    /* LOADING */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #333;
      border-radius: 50%;
      border-top-color: #0f0;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ONLINE USERS TICKER */
    .online-ticker {
      background: #111;
      border: 1px solid #222;
      padding: 8px 15px;
      margin-bottom: 20px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .online-ticker span {
      color: #0f0;
      font-weight: bold;
    }

    .ticker-items {
      display: flex;
      gap: 20px;
      color: #888;
    }

    .ticker-items div {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .green-dot {
      width: 8px;
      height: 8px;
      background: #0f0;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>

<div class="navbar">
  <div class="nav-left">
    <a onclick="showPage('home')" id="nav-home" class="active">Home</a>
    <a onclick="showPage('profile')" id="nav-profile">Profile</a>
    <a onclick="showPage('pastes')" id="nav-pastes">Pastes</a>
    <a onclick="showPage('users')" id="nav-users">Users</a>
  </div>
  <div class="nav-right">
    <span>‚óè <span id="onlineUsers">0</span> online</span>
    <span onclick="showLogin()" id="loginBtn">Login</span>
    <span onclick="handleLogout()" id="logoutBtn" class="hidden">Logout</span>
  </div>
</div>

<!-- ONLINE USERS TICKER -->
<div class="online-ticker">
  <div class="ticker-items">
    <div><span class="green-dot"></span> <span id="onlineNow">0</span> online now</div>
    <div>üìä <span id="totalUsers">0</span> total users</div>
    <div>üìù <span id="totalPastes">0</span> total pastes</div>
    <div>üëÅÔ∏è <span id="totalViews">0</span> total views</div>
  </div>
  <div>üî¥ JOIN @EXILED</div>
</div>

<!-- HERO SECTION -->
<div id="heroSection" class="hero">
  <div class="logo">exiled</div>
  <p>anonymous pastebin</p>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search for a paste...">
    <button onclick="searchPastes()">Search</button>

    <div class="radio-options">
      <label><input type="radio" name="search" id="searchTitle" checked> Search in title</label>
      <label><input type="radio" name="search" id="searchPaste"> Search in paste</label>
    </div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="container">
  <!-- HOME PAGE - ALL PUBLIC PASTES -->
  <div id="homePage">
    <h2>All Public Pastes</h2>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Comments</th>
            <th>Views</th>
            <th>Created By</th>
            <th>Added</th>
          </tr>
        </thead>
        <tbody id="allPastesList">
          <tr>
            <td colspan="5" class="empty-state">Loading pastes...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <div id="profilePage" class="hidden">
    <div id="profileViewContainer"></div>
  </div>

  <!-- PASTES PAGE -->
  <div id="pastesPage" class="hidden">
    <h2>Create New Paste</h2>
    <div class="create-paste">
      <input type="text" id="pasteTitle" placeholder="Title" maxlength="100">
      <textarea id="pasteContent" placeholder="Paste content..."></textarea>
      <label class="checkbox-label">
        <input type="checkbox" id="privatePaste"> Private paste
      </label>
      <button onclick="uploadPaste()" id="uploadBtn">Upload Paste</button>
      <div id="uploadMessage" class="message hidden"></div>
    </div>

    <h2 style="margin-top: 30px;">Your Pastes</h2>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Views</th>
            <th>Comments</th>
            <th>Created</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="userPastesList">
          <tr>
            <td colspan="5" class="empty-state">You haven't created any pastes yet.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- USERS PAGE -->
  <div id="usersPage" class="hidden">
    <h2>All Users</h2>
    <div class="users-grid" id="usersList">
      <div class="empty-state">Loading users...</div>
    </div>
  </div>

  <!-- PASTE VIEW PAGE (with comments) -->
  <div id="pasteViewPage" class="hidden">
    <div id="pasteViewContainer"></div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; align-items: center; justify-content: center;">
  <div class="auth-box" style="width: 100%; max-width: 400px; margin: 0;">
    <h2>Login to exiled</h2>
    <input type="email" id="loginEmail" placeholder="Email" autocomplete="email">
    <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
    <button class="primary" onclick="handleLogin()" id="modalLoginBtn">Login</button>
    <button onclick="handleSignup()" id="modalSignupBtn">Sign Up</button>
    <button onclick="closeLoginModal()" style="background: transparent; border: none; color: #888; margin-top: 10px;">Close</button>
    <div id="modalAuthMessage" class="message hidden"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Supabase setup
  const SUPABASE_URL = "https://opixidygpndbfuisjkrk.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_N6RdTgjgUHQbdtvPX9uPqA_VTraUegI";
  
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      autoRefreshToken: true,
      persistSession: true,
      detectSessionInUrl: true
    }
  });

  // Global state
  let currentUser = null;
  let currentProfile = null;
  const RICH_USER_EMAIL = "ikiikikikijujijij@gmail.com";
  let onlineUsers = [];

  // DOM Elements
  const pages = {
    home: document.getElementById('homePage'),
    profile: document.getElementById('profilePage'),
    pastes: document.getElementById('pastesPage'),
    users: document.getElementById('usersPage'),
    paste: document.getElementById('pasteViewPage')
  };

  const navLinks = {
    home: document.getElementById('nav-home'),
    profile: document.getElementById('nav-profile'),
    pastes: document.getElementById('nav-pastes'),
    users: document.getElementById('nav-users')
  };

  const heroSection = document.getElementById('heroSection');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginModal = document.getElementById('loginModal');

  // Initialize
  (async function init() {
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      currentUser = session?.user || null;
      
      if (currentUser) {
        await loadUserProfile();
      }
      
      updateUI();
      await Promise.all([
        loadUsers(),
        loadAllPastes(),
        updateStats(),
        updateOnlineUsers()
      ]);
      checkURLPath();
      
      // Update online users every 30 seconds
      setInterval(updateOnlineUsers, 30000);
    } catch (error) {
      console.error('Init error:', error);
    }
    
    window.addEventListener('popstate', checkURLPath);
  })();

  // URL routing with clean paths
  function checkURLPath() {
    const path = window.location.pathname.substring(1); // Remove leading /
    
    if (path.startsWith('user/')) {
      const userId = path.replace('user/', '');
      viewUserProfile(userId);
    } else if (path === 'profile') {
      if (currentUser) {
        viewUserProfile(currentUser.id);
      } else {
        showLogin();
      }
    } else if (path && !path.startsWith('user/') && !path.includes('/')) {
      // This is a paste URL (exiled.lat/pastename)
      viewPasteByTitle(path);
    } else if (path === 'pastes') {
      showPage('pastes');
      if (currentUser) {
        loadUserPastes();
      }
    } else if (path === 'users') {
      showPage('users');
    } else {
      showPage('home');
    }
  }

  // Update URL without reload
  function updateURL(path) {
    window.history.pushState({}, '', `/${path}`);
  }

  // Page navigation
  function showPage(page) {
    Object.values(pages).forEach(p => {
      if (p) p.classList.add('hidden');
    });
    
    Object.values(navLinks).forEach(link => {
      if (link) link.classList.remove('active');
    });
    
    if (pages[page]) {
      pages[page].classList.remove('hidden');
      
      if (navLinks[page]) {
        navLinks[page].classList.add('active');
      }
      
      if (page === 'home') {
        updateURL('');
        heroSection.style.display = 'block';
      } else {
        updateURL(page);
        heroSection.style.display = 'none';
      }
    }
  }

  // Load user profile
  async function loadUserProfile() {
    if (!currentUser) return;
    
    try {
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();
        
      if (error && error.code === 'PGRST116') {
        // Profile doesn't exist, create it
        const { error: insertError } = await supabaseClient
          .from('profiles')
          .insert([{
            id: currentUser.id,
            email: currentUser.email,
            username: currentUser.email.split('@')[0],
            created_at: new Date().toISOString()
          }]);
          
        if (!insertError) {
          const { data: newProfile } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();
          currentProfile = newProfile;
        }
      } else if (error) {
        console.error('Error loading profile:', error);
      } else {
        currentProfile = data;
      }
    } catch (error) {
      console.error('Error in loadUserProfile:', error);
    }
  }

  // Load ALL public pastes
  async function loadAllPastes() {
    try {
      const { data, error } = await supabaseClient
        .from('pastes')
        .select('*, profiles!inner(username, email, avatar_url), comments(count)')
        .eq('is_private', false)
        .order('created_at', { ascending: false });

      if (error) throw error;

      const tbody = document.getElementById('allPastesList');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No pastes yet. Be the first to upload!</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(paste => {
        const isRichUser = paste.profiles?.email === RICH_USER_EMAIL;
        const commentCount = paste.comments?.[0]?.count || 0;
        // Create URL-friendly title
        const urlTitle = encodeURIComponent(paste.title.toLowerCase().replace(/[^a-z0-9]/g, '-'));
        return `
          <tr>
            <td class="title" onclick="viewPasteByTitle('${urlTitle}', '${paste.id}')">${escapeHtml(paste.title)}</td>
            <td class="comment-count">${commentCount}</td>
            <td class="views">${paste.views || 0}</td>
            <td>
              <span class="${isRichUser ? 'username-white' : 'username-blue'}">${escapeHtml(paste.profiles?.username || 'Anonymous')}</span>
              ${isRichUser ? '<span class="rich-badge">[RICH]</span>' : ''}
            </td>
            <td class="date">${new Date(paste.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
          </tr>
        `;
      }).join('');
      
      // Update total pastes count
      document.getElementById('totalPastes').textContent = data.length;
    } catch (error) {
      console.error('Error loading pastes:', error);
      document.getElementById('allPastesList').innerHTML = '<tr><td colspan="5" class="empty-state">Error loading pastes</td></tr>';
    }
  }

  // View paste by title (clean URL)
  async function viewPasteByTitle(urlTitle, pasteId = null) {
    try {
      let paste;
      
      if (pasteId) {
        // If we have the ID, use it directly
        const { data, error } = await supabaseClient
          .from('pastes')
          .select('*, profiles!inner(username, email, avatar_url)')
          .eq('id', pasteId)
          .single();
          
        if (error) throw error;
        paste = data;
      } else {
        // Otherwise find by title (decode URL title back to original)
        const decodedTitle = decodeURIComponent(urlTitle).replace(/-/g, ' ');
        const { data, error } = await supabaseClient
          .from('pastes')
          .select('*, profiles!inner(username, email, avatar_url)')
          .eq('title', decodedTitle)
          .eq('is_private', false)
          .single();
          
        if (error) throw error;
        paste = data;
      }

      // Update URL
      const cleanTitle = paste.title.toLowerCase().replace(/[^a-z0-9]/g, '-');
      updateURL(cleanTitle);
      heroSection.style.display = 'none';
      
      // Increment views
      try {
        await supabaseClient.rpc('increment_paste_views', { paste_id: paste.id });
      } catch (e) {
        console.warn('Could not increment views:', e);
      }

      // Load comments for this paste
      const { data: comments, error: commentsError } = await supabaseClient
        .from('comments')
        .select('*, profiles(username, email)')
        .eq('paste_id', paste.id)
        .order('created_at', { ascending: true });

      const isRichUser = paste.profiles?.email === RICH_USER_EMAIL;

      const container = document.getElementById('pasteViewContainer');
      container.innerHTML = `
        <div class="paste-view">
          <div class="paste-header">
            <h1 class="paste-title">${escapeHtml(paste.title)}</h1>
            <div class="paste-meta">
              <span>üëÅÔ∏è ${paste.views || 0}</span>
              <span>üí¨ ${comments?.length || 0}</span>
              <span>üìÖ ${new Date(paste.created_at).toLocaleDateString()}</span>
            </div>
          </div>
          <div class="paste-content">
            ${escapeHtml(paste.content)}
          </div>
          <div style="margin-top: 15px; color: #888; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <span>Created by:</span>
            <span class="${isRichUser ? 'username-white' : 'username-blue'}">${escapeHtml(paste.profiles?.username || 'Anonymous')}</span>
            ${isRichUser ? '<span class="rich-badge">[RICH]</span>' : ''}
          </div>

          <!-- COMMENTS SECTION -->
          <div class="comments-section">
            <h3 style="color: #fff; margin-bottom: 15px;">Comments (${comments?.length || 0})</h3>
            
            ${currentUser ? `
              <div>
                <textarea id="newComment" class="comment-input" placeholder="Add a comment..."></textarea>
                <button class="comment-btn" onclick="addComment('${paste.id}')">Post Comment</button>
              </div>
            ` : `
              <p style="color: #888; margin: 10px 0;">Login to add comments</p>
            `}

            <div id="commentsList" style="margin-top: 20px;">
              ${comments && comments.length > 0 ? comments.map(comment => {
                const isCommentRich = comment.profiles?.email === RICH_USER_EMAIL;
                return `
                  <div class="comment">
                    <div class="comment-header">
                      <span class="comment-author ${isCommentRich ? 'username-white' : 'username-blue'}">
                        ${escapeHtml(comment.profiles?.username || 'Anonymous')}
                        ${isCommentRich ? '<span class="rich-badge">[RICH]</span>' : ''}
                      </span>
                      <span>${new Date(comment.created_at).toLocaleString()}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                  </div>
                `;
              }).join('') : '<p style="color: #888;">No comments yet.</p>'}
            </div>
          </div>

          <button class="back-btn" onclick="window.history.back()" style="margin-top: 20px;">‚Üê Back</button>
        </div>
      `;

      showPage('paste');
    } catch (error) {
      console.error('Error loading paste:', error);
      alert('Paste not found');
      showPage('home');
    }
  }

  // Add comment
  async function addComment(pasteId) {
    if (!currentUser) {
      showLogin();
      return;
    }

    const content = document.getElementById('newComment').value.trim();
    if (!content) return;

    try {
      const { error } = await supabaseClient
        .from('comments')
        .insert([{
          paste_id: pasteId,
          user_id: currentUser.id,
          author: currentProfile?.username || 'Anonymous',
          content: content,
          created_at: new Date().toISOString()
        }]);

      if (error) throw error;

      // Refresh the paste view
      viewPasteByTitle(null, pasteId);
    } catch (error) {
      console.error('Error adding comment:', error);
      alert('Error adding comment');
    }
  }

  // Upload paste
  async function uploadPaste() {
    if (!currentUser) {
      showLogin();
      return;
    }

    const title = document.getElementById('pasteTitle').value.trim();
    const content = document.getElementById('pasteContent').value.trim();
    const isPrivate = document.getElementById('privatePaste').checked;

    if (!title || !content) {
      showMessage('uploadMessage', 'Title and content required', 'error');
      return;
    }

    if (title.length > 100) {
      showMessage('uploadMessage', 'Title too long (max 100 chars)', 'error');
      return;
    }

    try {
      const { data, error } = await supabaseClient
        .from('pastes')
        .insert([{
          title,
          content,
          is_private: isPrivate,
          user_id: currentUser.id,
          username: currentProfile?.username || 'Anonymous',
          views: 0,
          created_at: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      showMessage('uploadMessage', 'Paste uploaded successfully!', 'success');
      document.getElementById('pasteTitle').value = '';
      document.getElementById('pasteContent').value = '';
      document.getElementById('privatePaste').checked = false;
      
      await Promise.all([
        loadUserPastes(),
        loadAllPastes(),
        updateStats()
      ]);

      // Redirect to the new paste
      if (data && data[0]) {
        const cleanTitle = data[0].title.toLowerCase().replace(/[^a-z0-9]/g, '-');
        setTimeout(() => {
          viewPasteByTitle(cleanTitle, data[0].id);
        }, 1000);
      }
    } catch (error) {
      showMessage('uploadMessage', error.message, 'error');
    }
  }

  // Load user's pastes
  async function loadUserPastes() {
    if (!currentUser) return;

    try {
      const { data, error } = await supabaseClient
        .from('pastes')
        .select('*, comments(count)')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });

      if (error) throw error;

      const tbody = document.getElementById('userPastesList');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">You haven\'t created any pastes yet.</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(paste => {
        const commentCount = paste.comments?.[0]?.count || 0;
        const cleanTitle = paste.title.toLowerCase().replace(/[^a-z0-9]/g, '-');
        return `
          <tr>
            <td class="title" onclick="viewPasteByTitle('${cleanTitle}', '${paste.id}')">${escapeHtml(paste.title)}</td>
            <td>${paste.views || 0}</td>
            <td>${commentCount}</td>
            <td class="date">${new Date(paste.created_at).toLocaleDateString()}</td>
            <td>${paste.is_private ? 'üîí Private' : 'üåç Public'}</td>
          </tr>
        `;
      }).join('');
    } catch (error) {
      console.error('Error loading user pastes:', error);
    }
  }

  // Check if file is GIF
  function isGifFile(file) {
    return file.type === 'image/gif' || file.name.toLowerCase().endsWith('.gif');
  }

  // View user profile
  async function viewUserProfile(userId) {
    showPage('profile');
    
    try {
      const { data: profile, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();

      if (error) {
        if (error.code === 'PGRST116') {
          document.getElementById('profileViewContainer').innerHTML = '<div class="empty-state">Profile not found</div>';
          return;
        }
        throw error;
      }

      const { data: pastes } = await supabaseClient
        .from('pastes')
        .select('*, comments(count)')
        .eq('user_id', userId)
        .eq('is_private', false)
        .order('created_at', { ascending: false })
        .limit(20);

      const isRichUser = profile.email === RICH_USER_EMAIL;
      const isOwnProfile = currentUser && currentUser.id === userId;
      const isAvatarGif = profile.avatar_url?.toLowerCase().includes('.gif');
      const isOnline = onlineUsers.includes(userId);

      const container = document.getElementById('profileViewContainer');
      container.innerHTML = `
        <div class="profile-view">
          <div class="profile-left">
            <div class="profile-avatar-large" ${isOwnProfile ? 'onclick="document.getElementById(\'avatarUpload\').click()"' : ''}>
              ${profile.avatar_url ? 
                `<img src="${profile.avatar_url}" alt="Avatar">` : 
                `<span>${profile.username ? profile.username.charAt(0).toUpperCase() : 'üë§'}</span>`
              }
              ${isAvatarGif ? '<span class="gif-indicator">GIF</span>' : ''}
            </div>
            ${isOwnProfile ? `
              <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
              <p style="color: #888; font-size: 11px; text-align: center; margin-top: 5px;">
                ${isRichUser ? '‚ú® You can upload GIFs (Rich perk)' : 'üì∑ Images only (GIFs for Rich users)'}
              </p>
            ` : ''}
            
            <div class="profile-username-large">
              <span class="${isRichUser ? 'username-white' : 'username-blue'}">${escapeHtml(profile.username || 'Anonymous')}</span>
              ${isRichUser ? '<span class="rich-badge">[RICH]</span>' : ''}
              ${isOnline ? '<span style="color: #0f0; margin-left: 5px;">‚óè</span>' : ''}
            </div>
            <div class="profile-uid">UID: ${userId.substring(0, 8)}</div>
            
            <div class="profile-stats">
              <div class="stat">
                <div class="stat-value">${pastes?.length || 0}</div>
                <div class="stat-label">PASTES</div>
              </div>
              <div class="stat">
                <div class="stat-value">${profile.likes || 0}</div>
                <div class="stat-label">LIKES</div>
              </div>
              <div class="stat">
                <div class="stat-value">${profile.followers || 0}</div>
                <div class="stat-label">FOLLOWERS</div>
              </div>
            </div>

            <div class="profile-bio">
              ${profile.bio ? escapeHtml(profile.bio) : 'No bio yet.'}
            </div>

            ${isOwnProfile ? `
              <button class="back-btn" style="width: 100%;" onclick="toggleEditProfile()" id="profileEditBtn">Edit Profile</button>
              
              <div id="profileEditForm" class="edit-form hidden">
                <input type="text" id="editUsernameInput" placeholder="Username" value="${escapeHtml(profile.username || '')}" maxlength="30">
                <textarea id="editBioInput" placeholder="Bio" maxlength="500">${escapeHtml(profile.bio || '')}</textarea>
                <button class="primary" onclick="saveProfileChanges()">Save Changes</button>
                <button onclick="toggleEditProfile()">Cancel</button>
              </div>
            ` : ''}

            <div class="share-url">
              <input type="text" id="profileShareUrl" value="${window.location.origin}/user/${userId}" readonly>
              <button onclick="copyProfileUrl()">Copy</button>
            </div>
          </div>

          <div class="profile-right">
            <div class="profile-tabs">
              <div class="profile-tab active">Pastes</div>
            </div>
            <div id="userPastesContainer">
              ${pastes && pastes.length > 0 ? 
                pastes.slice(0, 5).map(paste => {
                  const commentCount = paste.comments?.[0]?.count || 0;
                  const cleanTitle = paste.title.toLowerCase().replace(/[^a-z0-9]/g, '-');
                  return `
                    <div style="padding: 10px; border-bottom: 1px solid #222;">
                      <div style="color: #fff; cursor: pointer; margin-bottom: 4px;" onclick="viewPasteByTitle('${cleanTitle}', '${paste.id}')">${escapeHtml(paste.title)}</div>
                      <div style="color: #888; font-size: 11px;">
                        ${new Date(paste.created_at).toLocaleDateString()} ¬∑ ${paste.views || 0} views ¬∑ ${commentCount} comments
                      </div>
                    </div>
                  `;
                }).join('') : 
                '<p style="color: #888;">No public pastes yet.</p>'
              }
            </div>
          </div>
        </div>
      `;
    } catch (error) {
      console.error('Error loading profile:', error);
      document.getElementById('profileViewContainer').innerHTML = '<div class="empty-state">Error loading profile</div>';
    }
  }

  // Avatar upload with GIF restriction
  async function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file || !currentUser) return;

    const isRichUser = currentUser.email === RICH_USER_EMAIL;
    const isGif = isGifFile(file);

    if (isGif && !isRichUser) {
      alert('Only [RICH] users can upload GIFs as profile pictures');
      return;
    }

    if (!isRichUser && !file.type.startsWith('image/')) {
      alert('Please upload an image file');
      return;
    }

    const maxSize = isGif ? 5 * 1024 * 1024 : 2 * 1024 * 1024;
    if (file.size > maxSize) {
      alert(`File too large. Max size: ${isGif ? '5MB' : '2MB'}`);
      return;
    }

    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
      
      const { error: uploadError } = await supabaseClient.storage
        .from('avatars')
        .upload(fileName, file);

      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabaseClient.storage
        .from('avatars')
        .getPublicUrl(fileName);

      const { error: updateError } = await supabaseClient
        .from('profiles')
        .update({ avatar_url: publicUrl })
        .eq('id', currentUser.id);

      if (updateError) throw updateError;

      alert(isGif ? 'GIF avatar uploaded successfully!' : 'Avatar updated!');
      viewUserProfile(currentUser.id);
      loadUsers();
    } catch (error) {
      alert(error.message);
    }
  }

  // Toggle edit profile
  function toggleEditProfile() {
    const form = document.getElementById('profileEditForm');
    const btn = document.getElementById('profileEditBtn');
    
    if (form.classList.contains('hidden')) {
      form.classList.remove('hidden');
      btn.textContent = 'Cancel';
    } else {
      form.classList.add('hidden');
      btn.textContent = 'Edit Profile';
    }
  }

  // Save profile changes
  async function saveProfileChanges() {
    const username = document.getElementById('editUsernameInput').value.trim();
    const bio = document.getElementById('editBioInput').value.trim();

    if (username && username.length > 30) {
      alert('Username too long (max 30 chars)');
      return;
    }

    if (bio && bio.length > 500) {
      alert('Bio too long (max 500 chars)');
      return;
    }

    try {
      const { error } = await supabaseClient
        .from('profiles')
        .update({
          username: username || null,
          bio: bio || null
        })
        .eq('id', currentUser.id);

      if (error) throw error;

      alert('Profile updated!');
      toggleEditProfile();
      viewUserProfile(currentUser.id);
      loadUsers();
    } catch (error) {
      alert(error.message);
    }
  }

  // Copy profile URL
  function copyProfileUrl() {
    const urlInput = document.getElementById('profileShareUrl');
    urlInput.select();
    document.execCommand('copy');
    alert('Profile URL copied!');
  }

  // Load users
  async function loadUsers() {
    try {
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(50);

      if (error) throw error;

      const usersList = document.getElementById('usersList');
      
      if (!data || data.length === 0) {
        usersList.innerHTML = '<div class="empty-state">No users found.</div>';
        return;
      }

      usersList.innerHTML = data.map(user => {
        const isRichUser = user.email === RICH_USER_EMAIL;
        const isAvatarGif = user.avatar_url?.toLowerCase().includes('.gif');
        const isOnline = onlineUsers.includes(user.id);
        return `
          <div class="user-card" onclick="viewUserProfile('${user.id}')">
            <div class="user-avatar">
              ${user.avatar_url ? 
                `<img src="${user.avatar_url}" alt="${escapeHtml(user.username || 'User')}">` : 
                'üë§'
              }
            </div>
            <div class="user-name ${isRichUser ? 'username-white' : 'username-blue'}">
              ${escapeHtml(user.username || 'Anonymous')}
              ${isRichUser ? '<span class="rich-badge">[RICH]</span>' : ''}
              ${isOnline ? '<span style="color: #0f0; margin-left: 3px;">‚óè</span>' : ''}
            </div>
            <div class="user-joined">
              Joined: ${new Date(user.created_at).toLocaleDateString()}
            </div>
            ${isAvatarGif ? '<span class="gif-tag">GIF</span>' : ''}
          </div>
        `;
      }).join('');
      
      // Update total users count
      document.getElementById('totalUsers').textContent = data.length;
    } catch (error) {
      console.error('Error loading users:', error);
      document.getElementById('usersList').innerHTML = '<div class="empty-state">Error loading users</div>';
    }
  }

  // Update online users
  async function updateOnlineUsers() {
    try {
      // This is a simulation - in production you'd use a real-time presence system
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('id')
        .limit(20);
        
      if (error) throw error;
      
      // Simulate online users (random subset)
      onlineUsers = data
        .map(u => u.id)
        .sort(() => 0.5 - Math.random())
        .slice(0, Math.floor(Math.random() * 10) + 5);
      
      const onlineCount = onlineUsers.length;
      document.getElementById('onlineUsers').textContent = onlineCount;
      document.getElementById('onlineNow').textContent = onlineCount;
      
      // Refresh users list to show online indicators
      if (!pages.users.classList.contains('hidden')) {
        loadUsers();
      }
    } catch (error) {
      console.error('Error updating online users:', error);
    }
  }

  // Search pastes
  async function searchPastes() {
    const query = document.getElementById('searchInput').value.trim();
    const searchTitle = document.getElementById('searchTitle').checked;
    
    if (!query) {
      loadAllPastes();
      return;
    }

    try {
      let data, error;
      
      if (searchTitle) {
        ({ data, error } = await supabaseClient
          .from('pastes')
          .select('*, profiles!inner(username, email, avatar_url), comments(count)')
          .eq('is_private', false)
          .ilike('title', `%${query}%`)
          .order('created_at', { ascending: false }));
      } else {
        ({ data, error } = await supabaseClient
          .from('pastes')
          .select('*, profiles!inner(username, email, avatar_url), comments(count)')
          .eq('is_private', false)
          .ilike('content', `%${query}%`)
          .order('created_at', { ascending: false }));
      }

      if (error) throw error;

      const tbody = document.getElementById('allPastesList');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No pastes found matching "' + escapeHtml(query) + '"</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(paste => {
        const isRichUser = paste.profiles?.email === RICH_USER_EMAIL;
        const commentCount = paste.comments?.[0]?.count || 0;
        const cleanTitle = paste.title.toLowerCase().replace(/[^a-z0-9]/g, '-');
        return `
          <tr>
            <td class="title" onclick="viewPasteByTitle('${cleanTitle}', '${paste.id}')">${escapeHtml(paste.title)}</td>
            <td class="comment-count">${commentCount}</td>
            <td class="views">${paste.views || 0}</td>
            <td>
              <span class="${isRichUser ? 'username-white' : 'username-blue'}">${escapeHtml(paste.profiles?.username || 'Anonymous')}</span>
              ${isRichUser ? '<span class="rich-badge">[RICH]</span>' : ''}
            </td>
            <td class="date">${new Date(paste.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
          </tr>
        `;
      }).join('');
    } catch (error) {
      console.error('Error searching pastes:', error);
      alert('Error searching pastes');
    }
  }

  // Update UI based on auth
  function updateUI() {
    if (currentUser) {
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
    } else {
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
    }
  }

  // Show login modal
  function showLogin() {
    loginModal.classList.remove('hidden');
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
  }

  // Close login modal
  function closeLoginModal() {
    loginModal.classList.add('hidden');
  }

  // Auth
  async function handleSignup() {
    const email = document.getElementById('loginEmail')?.value.trim();
    const password = document.getElementById('loginPassword')?.value;

    if (!email || !password) {
      showModalMessage('Email and password required', 'error');
      return;
    }

    if (password.length < 6) {
      showModalMessage('Password must be at least 6 characters', 'error');
      return;
    }

    try {
      const { data, error } = await supabaseClient.auth.signUp({ 
        email, 
        password,
        options: {
          emailRedirectTo: window.location.origin
        }
      });

      if (error) throw error;

      if (data.user) {
        // Create profile
        const { error: profileError } = await supabaseClient
          .from('profiles')
          .upsert([{
            id: data.user.id,
            email: email,
            username: email.split('@')[0],
            created_at: new Date().toISOString()
          }]);

        if (profileError) {
          console.error('Profile creation error:', profileError);
        }
      }

      showModalMessage('Signup successful! Check email for confirmation.', 'success');
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    } catch (error) {
      showModalMessage(error.message, 'error');
    }
  }

  async function handleLogin() {
    const email = document.getElementById('loginEmail')?.value.trim();
    const password = document.getElementById('loginPassword')?.value;

    if (!email || !password) {
      showModalMessage('Email and password required', 'error');
      return;
    }

    try {
      const { data, error } = await supabaseClient.auth.signInWithPassword({ 
        email, 
        password 
      });

      if (error) throw error;
      
      showModalMessage('Login successful!', 'success');
      
      setTimeout(async () => {
        closeLoginModal();
        currentUser = data.user;
        await loadUserProfile();
        updateUI();
        window.location.pathname = '/';
        showPage('home');
        await loadAllPastes();
      }, 1000);
    } catch (error) {
      showModalMessage(error.message, 'error');
    }
  }

  async function handleLogout() {
    try {
      await supabaseClient.auth.signOut();
      currentUser = null;
      currentProfile = null;
      updateUI();
      window.location.pathname = '/';
      showPage('home');
      await loadAllPastes();
      await loadUsers();
    } catch (error) {
      console.error('Logout error:', error);
    }
  }

  // Show message in modal
  function showModalMessage(message, type) {
    const msgEl = document.getElementById('modalAuthMessage');
    msgEl.textContent = message;
    msgEl.className = `message ${type}`;
    msgEl.classList.remove('hidden');
    setTimeout(() => msgEl.classList.add('hidden'), 5000);
  }

  // Update stats
  async function updateStats() {
    try {
      const { count: userCount } = await supabaseClient
        .from('profiles')
        .select('*', { count: 'exact', head: true });

      const { count: pasteCount } = await supabaseClient
        .from('pastes')
        .select('*', { count: 'exact', head: true })
        .eq('is_private', false);

      const { data: viewsData } = await supabaseClient
        .from('pastes')
        .select('views');

      const totalViews = viewsData?.reduce((sum, p) => sum + (p.views || 0), 0) || 0;

      document.getElementById('totalUsers').textContent = userCount || 0;
      document.getElementById('totalPastes').textContent = pasteCount || 0;
      document.getElementById('totalViews').textContent = totalViews.toLocaleString();
    } catch (error) {
      console.error('Error updating stats:', error);
    }
  }

  // Utility functions
  function showMessage(elementId, message, type) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = message;
      element.className = `message ${type}`;
      element.classList.remove('hidden');
      setTimeout(() => element.classList.add('hidden'), 5000);
    }
  }

  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Auth state change
  supabaseClient.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
      currentUser = session.user;
      await loadUserProfile();
      updateUI();
      await loadAllPastes();
      await loadUsers();
      await updateStats();
    } else if (event === 'SIGNED_OUT') {
      currentUser = null;
      currentProfile = null;
      updateUI();
    }
  });
</script>
</body>
</html>
