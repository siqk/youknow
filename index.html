<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>exiled</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #ccc;
      font-family: Arial, sans-serif;
    }

    /* NAVBAR */
    .navbar {
      background: #0d0d0d;
      border-bottom: 1px solid #222;
      padding: 12px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-left a {
      color: #aaa;
      margin-right: 25px;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }

    .nav-left a:hover {
      color: #fff;
    }

    .nav-left a.active {
      color: #fff;
      border-bottom: 1px solid #fff;
      padding-bottom: 3px;
    }

    .nav-right {
      font-size: 13px;
      color: #0f0;
    }

    /* HERO SECTION */
    .hero {
      text-align: center;
      padding: 40px 20px 20px;
    }

    .logo {
      font-size: 48px;
      font-weight: bold;
      color: #fff;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .hero p {
      color: #888;
      font-size: 14px;
    }

    /* SEARCH */
    .search-box {
      margin-top: 20px;
    }

    .search-box input[type="text"] {
      background: #111;
      border: 1px solid #333;
      padding: 10px;
      width: 250px;
      color: #fff;
    }

    .search-box button {
      background: #222;
      border: 1px solid #444;
      padding: 10px 15px;
      color: #fff;
      cursor: pointer;
    }

    .search-box button:hover {
      background: #333;
    }

    .radio-options {
      margin-top: 10px;
      font-size: 13px;
      color: #888;
    }

    .radio-options label {
      margin: 0 10px;
    }

    /* CONTENT */
    .container {
      width: 85%;
      margin: 30px auto;
    }

    h2 {
      color: #fff;
      border-bottom: 1px solid #222;
      padding-bottom: 10px;
      font-size: 18px;
      font-weight: normal;
    }

    /* TABLE */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th {
      background: #111;
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #333;
      font-size: 13px;
      color: #888;
      font-weight: normal;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #222;
      font-size: 13px;
    }

    tr:hover {
      background: #111;
    }

    .title {
      color: #fff;
      cursor: pointer;
    }

    .title:hover {
      text-decoration: underline;
    }

    .views {
      color: #0f0;
    }

    .username-blue {
      color: #4a9eff;
    }

    .username-white {
      color: #fff;
    }

    .rich-badge {
      color: #ffd700;
      margin-left: 3px;
      font-size: 11px;
    }

    .admin-badge {
      color: #ff4444;
      margin-left: 3px;
      font-size: 11px;
    }

    .comment-count {
      color: #888;
    }

    .date {
      color: #888;
    }

    /* PAGINATION */
    .pagination {
      text-align: center;
      margin-top: 25px;
    }

    .pagination a {
      display: inline-block;
      padding: 6px 12px;
      margin: 0 3px;
      background: #111;
      color: #aaa;
      border: 1px solid #333;
      text-decoration: none;
    }

    .pagination a:hover {
      background: #222;
      color: #fff;
    }

    /* PROFILE PAGE */
    .profile-view {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .profile-left {
      background: #111;
      border: 1px solid #222;
      padding: 20px;
    }

    .profile-avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 2px solid #333;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: #888;
      background: #1a1a1a;
      cursor: pointer;
      overflow: hidden;
      position: relative;
    }

    .profile-avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-avatar-large:hover::after {
      content: 'Change';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      text-align: center;
      padding: 5px;
      font-size: 11px;
    }

    .profile-username-large {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
    }

    .profile-uid {
      color: #888;
      font-size: 11px;
      text-align: center;
      margin-bottom: 15px;
    }

    .profile-stats {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      padding: 10px 0;
      border-top: 1px solid #222;
      border-bottom: 1px solid #222;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      color: #0f0;
      font-weight: bold;
    }

    .stat-label {
      font-size: 10px;
      color: #888;
    }

    .profile-bio {
      border: 1px solid #222;
      padding: 12px;
      margin: 15px 0;
      min-height: 60px;
      font-size: 12px;
    }

    .profile-right {
      background: #111;
      border: 1px solid #222;
      padding: 20px;
    }

    .profile-tabs {
      display: flex;
      gap: 20px;
      border-bottom: 1px solid #222;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .profile-tab {
      cursor: pointer;
      color: #888;
      font-size: 13px;
    }

    .profile-tab.active {
      color: #fff;
    }

    .share-url {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }

    .share-url input {
      flex: 1;
      background: #000;
      border: 1px solid #333;
      padding: 6px;
      color: #888;
      font-size: 11px;
    }

    .share-url button {
      padding: 6px 12px;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      cursor: pointer;
    }

    .share-url button:hover {
      background: #333;
    }

    /* EDIT FORM */
    .edit-form {
      margin-top: 15px;
    }

    .edit-form input,
    .edit-form textarea {
      width: 100%;
      background: #000;
      border: 1px solid #333;
      padding: 8px;
      color: #fff;
      margin: 5px 0;
    }

    .edit-form textarea {
      min-height: 60px;
      resize: vertical;
    }

    .edit-form button {
      width: 100%;
      padding: 8px;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      cursor: pointer;
      margin: 5px 0;
    }

    .edit-form button.primary {
      background: #0f0;
      color: #000;
      border: none;
    }

    .edit-form button:hover {
      background: #333;
    }

    /* USERS GRID */
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .user-card {
      background: #111;
      border: 1px solid #222;
      padding: 15px;
      text-align: center;
      cursor: pointer;
    }

    .user-card:hover {
      border-color: #444;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #1a1a1a;
      border: 1px solid #333;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #888;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .user-joined {
      color: #888;
      font-size: 11px;
    }

    /* PASTE VIEW */
    .paste-view {
      background: #111;
      border: 1px solid #222;
      padding: 25px;
    }

    .paste-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #222;
    }

    .paste-title {
      font-size: 24px;
      color: #fff;
    }

    .paste-meta {
      display: flex;
      gap: 20px;
      color: #888;
    }

    .paste-content {
      border: 1px solid #222;
      padding: 20px;
      min-height: 200px;
      font-family: monospace;
      white-space: pre-wrap;
      margin: 20px 0;
      background: #0a0a0a;
    }

    .back-btn {
      padding: 8px 15px;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      cursor: pointer;
    }

    .back-btn:hover {
      background: #333;
    }

    /* HIDDEN */
    .hidden {
      display: none !important;
    }

    /* MESSAGES */
    .message {
      padding: 10px;
      border: 1px solid #333;
      margin: 10px 0;
      text-align: center;
    }

    .message.success {
      border-color: #0f0;
      color: #0f0;
    }

    .message.error {
      border-color: #ff4444;
      color: #ff4444;
    }

    /* AUTH */
    .auth-box {
      max-width: 350px;
      margin: 40px auto;
      background: #111;
      border: 1px solid #222;
      padding: 30px;
    }

    .auth-box h2 {
      text-align: center;
      margin-bottom: 20px;
      border: none;
    }

    .auth-box input {
      width: 100%;
      background: #000;
      border: 1px solid #333;
      padding: 10px;
      color: #fff;
      margin: 10px 0;
    }

    .auth-box button {
      width: 100%;
      padding: 10px;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      cursor: pointer;
      margin: 5px 0;
    }

    .auth-box button.primary {
      background: #0f0;
      color: #000;
    }
  </style>
</head>
<body>

<div class="navbar">
  <div class="nav-left">
    <a onclick="showPage('home')" id="nav-home" class="active">Home</a>
    <a onclick="showPage('profile')" id="nav-profile">Profile</a>
    <a onclick="showPage('pastes')" id="nav-pastes">Pastes</a>
    <a onclick="showPage('users')" id="nav-users">Users</a>
  </div>
  <div class="nav-right" id="onlineCount">
    ‚óè <span id="onlineUsers">569</span>
  </div>
</div>

<!-- HERO SECTION (only on home) -->
<div id="heroSection" class="hero">
  <div class="logo">exiled</div>
  <p>anonymous pastebin</p>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search for a paste...">
    <button onclick="searchPastes()">Search</button>

    <div class="radio-options">
      <label><input type="radio" name="search" id="searchTitle" checked> Search in title</label>
      <label><input type="radio" name="search" id="searchPaste"> Search in paste</label>
    </div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="container">
  <!-- HOME PAGE (Pinned Pastes) -->
  <div id="homePage">
    <h2>Pinned Pastes</h2>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Comments</th>
          <th>Views</th>
          <th>Created By</th>
          <th>Added</th>
        </tr>
      </thead>
      <tbody id="pinnedPastes">
        <tr>
          <td class="title" onclick="viewPaste('Can Blabcity Owner')">Can Blabcity Owner</td>
          <td class="comment-count">851</td>
          <td class="views">‚Äî</td>
          <td><span class="username-white">vvsivsvs</span><span class="rich-badge">[Rich]</span></td>
          <td class="date">Feb 12, 2026</td>
        </tr>
        <tr>
          <td class="title" onclick="viewPaste('Revenge Jack Butterfield')">Revenge Jack Butterfield</td>
          <td class="comment-count">2028</td>
          <td class="views">‚Äî</td>
          <td><span class="username-blue">Anonymous</span></td>
          <td class="date">Feb 8, 2026</td>
        </tr>
        <tr>
          <td class="title" onclick="viewPaste('JOIN LICK ON TELEGRAM')">JOIN LICK ON TELEGRAM</td>
          <td class="comment-count">2418</td>
          <td class="views">‚Äî</td>
          <td><span class="username-blue">Anonymous</span></td>
          <td class="date">Feb 7, 2026</td>
        </tr>
        <tr>
          <td class="title" onclick="viewPaste('NCSC UK undercover agents')">NCSC UK undercover agents</td>
          <td class="comment-count">174</td>
          <td class="views">12556</td>
          <td><span class="username-blue">Anonymous</span></td>
          <td class="date">Jan 8, 2026</td>
        </tr>
        <tr>
          <td class="title" onclick="viewPaste('How to Ensure Your Paste Stays Up')">How to Ensure Your Paste Stays Up</td>
          <td class="comment-count">260266</td>
          <td class="views">‚Äî</td>
          <td><span class="username-blue">Admin</span><span class="admin-badge">[Admin]</span></td>
          <td class="date">Nov 20, 2020</td>
        </tr>
        <tr>
          <td class="title" onclick="viewPaste('Transparency Report')">Transparency Report</td>
          <td class="comment-count">156673</td>
          <td class="views">‚Äî</td>
          <td><span class="username-blue">hardline</span><span class="admin-badge">[Manager]</span></td>
          <td class="date">Jun 20, 2020</td>
        </tr>
      </tbody>
    </table>

    <div class="pagination">
      <a href="#"><</a>
      <a href="#">1</a>
      <a href="#">2</a>
      <a href="#">3</a>
      <a href="#">></a>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <div id="profilePage" class="hidden">
    <div id="profileViewContainer"></div>
  </div>

  <!-- PASTES PAGE (All Pastes) -->
  <div id="pastesPage" class="hidden">
    <h2>All Pastes</h2>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Comments</th>
          <th>Views</th>
          <th>Created By</th>
          <th>Added</th>
        </tr>
      </thead>
      <tbody id="allPastes">
        <!-- Will be populated with real data -->
        <tr>
          <td class="title" onclick="viewPaste('Example Paste 1')">Example Paste 1</td>
          <td class="comment-count">12</td>
          <td class="views">855</td>
          <td><span class="username-blue">User1</span></td>
          <td class="date">Feb 14, 2026</td>
        </tr>
        <tr>
          <td class="title" onclick="viewPaste('Example Paste 2')">Example Paste 2</td>
          <td class="comment-count">5</td>
          <td class="views">2030</td>
          <td><span class="username-blue">User2</span></td>
          <td class="date">Feb 13, 2026</td>
        </tr>
      </tbody>
    </table>
    <div class="pagination">
      <a href="#"><</a>
      <a href="#">1</a>
      <a href="#">2</a>
      <a href="#">3</a>
      <a href="#">></a>
    </div>
  </div>

  <!-- USERS PAGE -->
  <div id="usersPage" class="hidden">
    <h2>Users</h2>
    <div class="users-grid" id="usersList"></div>
  </div>

  <!-- PASTE VIEW PAGE -->
  <div id="pasteViewPage" class="hidden">
    <div id="pasteViewContainer"></div>
  </div>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="hidden">
    <div class="auth-box">
      <h2>Login to exiled</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button class="primary" onclick="handleLogin()">Login</button>
      <button onclick="handleSignup()">Sign Up</button>
      <div id="authMessage" class="message hidden"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Supabase setup
  const SUPABASE_URL = "https://opixidygpndbfuisjkrk.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_N6RdTgjgUHQbdtvPX9uPqA_VTraUegI";
  
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      autoRefreshToken: true,
      persistSession: true
    }
  });

  // Global state
  let currentUser = null;
  let currentProfile = null;
  const RICH_USER_EMAIL = "ikiikikikijujijij@gmail.com";

  // DOM Elements
  const pages = {
    home: document.getElementById('homePage'),
    profile: document.getElementById('profilePage'),
    pastes: document.getElementById('pastesPage'),
    users: document.getElementById('usersPage'),
    paste: document.getElementById('pasteViewPage'),
    login: document.getElementById('loginPage')
  };

  const navLinks = {
    home: document.getElementById('nav-home'),
    profile: document.getElementById('nav-profile'),
    pastes: document.getElementById('nav-pastes'),
    users: document.getElementById('nav-users')
  };

  const heroSection = document.getElementById('heroSection');

  // Initialize
  (async function init() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    currentUser = session?.user || null;
    updateUI();
    loadUsers();
    updateStats();
    checkURLHash();
    window.addEventListener('hashchange', checkURLHash);
  })();

  // URL routing
  function checkURLHash() {
    const hash = window.location.hash.substring(1);
    
    if (hash.startsWith('user/')) {
      const userId = hash.replace('user/', '');
      viewUserProfile(userId);
    } else if (hash === 'profile') {
      if (currentUser) {
        viewUserProfile(currentUser.id);
      } else {
        showPage('login');
      }
    } else if (hash.startsWith('paste/')) {
      const pasteTitle = decodeURIComponent(hash.replace('paste/', ''));
      viewPaste(pasteTitle);
    } else if (hash === 'pastes') {
      showPage('pastes');
    } else if (hash === 'users') {
      showPage('users');
    } else {
      showPage('home');
    }
  }

  // Page navigation
  function showPage(page) {
    // Hide all pages
    Object.values(pages).forEach(p => {
      if (p) p.classList.add('hidden');
    });
    
    // Remove active class from nav links
    Object.values(navLinks).forEach(link => {
      if (link) link.classList.remove('active');
    });
    
    // Show selected page
    if (pages[page]) {
      pages[page].classList.remove('hidden');
      
      // Add active class to nav link
      if (navLinks[page]) {
        navLinks[page].classList.add('active');
      }
      
      // Update hash
      if (page === 'home') {
        window.location.hash = '';
        heroSection.style.display = 'block';
      } else {
        window.location.hash = page;
        heroSection.style.display = 'none';
      }
    } else if (page === 'login') {
      pages.login.classList.remove('hidden');
      heroSection.style.display = 'none';
      window.location.hash = 'login';
    }
  }

  // Show login
  function showLogin() {
    showPage('login');
  }

  // Show my profile
  function showMyProfile() {
    if (!currentUser) {
      showLogin();
      return;
    }
    window.location.hash = 'profile';
    viewUserProfile(currentUser.id);
  }

  // View paste
  function viewPaste(title) {
    window.location.hash = 'paste/' + encodeURIComponent(title);
    
    const container = document.getElementById('pasteViewContainer');
    container.innerHTML = `
      <div class="paste-view">
        <div class="paste-header">
          <h1 class="paste-title">${title}</h1>
          <div class="paste-meta">
            <span>üëÅÔ∏è 0 views</span>
            <span>üí¨ 0 comments</span>
            <span>üìÖ ${new Date().toLocaleDateString()}</span>
          </div>
        </div>
        <div class="paste-content">
          Paste content would appear here...
        </div>
        <button class="back-btn" onclick="showPage('home')">‚Üê Back</button>
      </div>
    `;
    
    showPage('paste');
  }

  // View user profile
  async function viewUserProfile(userId) {
    showPage('profile');
    
    try {
      const { data: profile, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();

      if (error) throw error;

      const { data: pastes } = await supabaseClient
        .from('pastes')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

      const isRichUser = profile.email === RICH_USER_EMAIL;
      const isOwnProfile = currentUser && currentUser.id === userId;

      const container = document.getElementById('profileViewContainer');
      container.innerHTML = `
        <div class="profile-view">
          <div class="profile-left">
            <div class="profile-avatar-large" ${isOwnProfile ? 'onclick="document.getElementById(\'avatarUpload\').click()"' : ''}>
              ${profile.avatar_url ? 
                `<img src="${profile.avatar_url}">` : 
                `<span>${profile.username ? profile.username.charAt(0).toUpperCase() : 'üë§'}</span>`
              }
            </div>
            ${isOwnProfile ? `
              <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
            ` : ''}
            
            <div class="profile-username-large">
              <span class="${isRichUser ? 'username-white' : 'username-blue'}">${escapeHtml(profile.username || 'Anonymous')}</span>
              ${isRichUser ? '<span class="rich-badge">[Rich]</span>' : ''}
            </div>
            <div class="profile-uid">UID: ${userId.substring(0, 8)}</div>
            
            <div class="profile-stats">
              <div class="stat">
                <div class="stat-value">${pastes?.length || 0}</div>
                <div class="stat-label">PASTES</div>
              </div>
              <div class="stat">
                <div class="stat-value">${profile.likes || 0}</div>
                <div class="stat-label">LIKES</div>
              </div>
              <div class="stat">
                <div class="stat-value">${profile.followers || 0}</div>
                <div class="stat-label">FOLLOWERS</div>
              </div>
            </div>

            <div class="profile-bio">
              ${profile.bio || 'No bio yet.'}
            </div>

            ${isOwnProfile ? `
              <button class="back-btn" style="width: 100%;" onclick="toggleEditProfile()" id="profileEditBtn">Edit Profile</button>
              
              <div id="profileEditForm" class="edit-form hidden">
                <input type="text" id="editUsernameInput" placeholder="Username" value="${escapeHtml(profile.username || '')}">
                <textarea id="editBioInput" placeholder="Bio">${escapeHtml(profile.bio || '')}</textarea>
                <button class="primary" onclick="saveProfileChanges()">Save Changes</button>
                <button onclick="toggleEditProfile()">Cancel</button>
              </div>
            ` : ''}

            <div class="share-url">
              <input type="text" id="profileShareUrl" value="${window.location.origin}/#user/${userId}" readonly>
              <button onclick="copyProfileUrl()">Copy</button>
            </div>
          </div>

          <div class="profile-right">
            <div class="profile-tabs">
              <div class="profile-tab active">Pastes</div>
            </div>
            <div id="userPastesContainer">
              ${pastes && pastes.length > 0 ? 
                pastes.slice(0, 5).map(paste => `
                  <div style="padding: 10px; border-bottom: 1px solid #222;">
                    <div style="color: #fff; cursor: pointer;" onclick="viewPaste('${escapeHtml(paste.title)}')">${escapeHtml(paste.title)}</div>
                    <div style="color: #888; font-size: 11px; margin-top: 4px;">
                      ${new Date(paste.created_at).toLocaleDateString()} ¬∑ ${paste.views || 0} views
                    </div>
                  </div>
                `).join('') : 
                '<p style="color: #888;">No pastes yet.</p>'
              }
            </div>
          </div>
        </div>
      `;
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }

  // Avatar upload
  async function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file || !currentUser) return;

    if (!file.type.startsWith('image/')) {
      alert('Please upload an image file');
      return;
    }

    if (file.size > 2 * 1024 * 1024) {
      alert('Image must be less than 2MB');
      return;
    }

    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
      
      const { error: uploadError } = await supabaseClient.storage
        .from('avatars')
        .upload(fileName, file);

      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabaseClient.storage
        .from('avatars')
        .getPublicUrl(fileName);

      const { error: updateError } = await supabaseClient
        .from('profiles')
        .update({ avatar_url: publicUrl })
        .eq('id', currentUser.id);

      if (updateError) throw updateError;

      alert('Avatar updated!');
      viewUserProfile(currentUser.id);
      loadSidebarProfile();
    } catch (error) {
      alert(error.message);
    }
  }

  // Toggle edit profile
  function toggleEditProfile() {
    const form = document.getElementById('profileEditForm');
    const btn = document.getElementById('profileEditBtn');
    
    if (form.classList.contains('hidden')) {
      form.classList.remove('hidden');
      btn.textContent = 'Cancel';
    } else {
      form.classList.add('hidden');
      btn.textContent = 'Edit Profile';
    }
  }

  // Save profile changes
  async function saveProfileChanges() {
    const username = document.getElementById('editUsernameInput').value.trim();
    const bio = document.getElementById('editBioInput').value.trim();

    try {
      const { error } = await supabaseClient
        .from('profiles')
        .update({
          username: username || null,
          bio: bio || null
        })
        .eq('id', currentUser.id);

      if (error) throw error;

      alert('Profile updated!');
      toggleEditProfile();
      viewUserProfile(currentUser.id);
    } catch (error) {
      alert(error.message);
    }
  }

  // Copy profile URL
  function copyProfileUrl() {
    const urlInput = document.getElementById('profileShareUrl');
    urlInput.select();
    document.execCommand('copy');
    alert('Profile URL copied!');
  }

  // Load users
  async function loadUsers() {
    try {
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .limit(20);

      if (error) throw error;

      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '';

      if (data && data.length > 0) {
        data.forEach(user => {
          const isRichUser = user.email === RICH_USER_EMAIL;
          usersList.innerHTML += `
            <div class="user-card" onclick="viewUserProfile('${user.id}')">
              <div class="user-avatar">
                ${user.avatar_url ? 
                  `<img src="${user.avatar_url}">` : 
                  'üë§'
                }
              </div>
              <div class="user-name ${isRichUser ? 'username-white' : 'username-blue'}">
                ${escapeHtml(user.username || 'Anonymous')}
                ${isRichUser ? '<span class="rich-badge">[Rich]</span>' : ''}
              </div>
              <div class="user-joined">
                Joined: ${new Date(user.created_at).toLocaleDateString()}
              </div>
            </div>
          `;
        });
      }
    } catch (error) {
      console.error('Error loading users:', error);
    }
  }

  // Search pastes
  function searchPastes() {
    const query = document.getElementById('searchInput').value;
    alert(`Searching for: ${query || 'all pastes'}`);
  }

  // Update UI based on auth
  function updateUI() {
    const profileLink = document.getElementById('nav-profile');
    
    if (currentUser) {
      profileLink.style.display = 'inline-block';
    } else {
      profileLink.style.display = 'inline-block'; // Always show, but redirects to login
    }
  }

  // Auth
  async function handleSignup() {
    const email = document.getElementById('email')?.value.trim();
    const password = document.getElementById('password')?.value;

    if (!email || !password) {
      alert('Email and password required');
      return;
    }

    try {
      const { data, error } = await supabaseClient.auth.signUp({ 
        email, 
        password 
      });

      if (error) throw error;

      alert('Signup successful! Check email for confirmation.');
    } catch (error) {
      alert(error.message);
    }
  }

  async function handleLogin() {
    const email = document.getElementById('email')?.value.trim();
    const password = document.getElementById('password')?.value;

    try {
      const { data, error } = await supabaseClient.auth.signInWithPassword({ 
        email, 
        password 
      });

      if (error) throw error;
      
      alert('Login successful!');
      window.location.hash = '';
      showPage('home');
    } catch (error) {
      alert(error.message);
    }
  }

  async function handleLogout() {
    await supabaseClient.auth.signOut();
    currentUser = null;
    window.location.hash = '';
    showPage('home');
  }

  // Update stats
  function updateStats() {
    document.getElementById('onlineUsers').textContent = Math.floor(Math.random() * 100) + 500;
  }

  // Utility
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Auth state change
  supabaseClient.auth.onAuthStateChange((event, session) => {
    currentUser = session?.user || null;
    updateUI();
    if (currentUser) {
      loadUsers();
    }
  });
</script>
</body>
</html>
